<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>formbar.config &mdash; Formbar 0.20.3 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.20.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Formbar 0.20.3 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Formbar 0.20.3 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for formbar.config</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">gettext</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">from</span> <span class="nn">formbar.rules</span> <span class="k">import</span> <span class="n">Rule</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">gettext</span><span class="o">.</span><span class="n">gettext</span>

<span class="n">required_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This field is required. You must provide a value&quot;</span><span class="p">)</span>
<span class="n">desired_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This field is desired. Please provide a value&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../api.html#formbar.config.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the parsed XML form the given file. The function will load</span>
<span class="sd">    the file located in path and than returns the parsed content.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the parsed XML. This is a helper function to be used in</span>
<span class="sd">    connection with loading the configuration files.</span>
<span class="sd">    :xml: XML string to be parsed</span>
<span class="sd">    :returns: DOM of the parsed XML</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">handle_inheritance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">handle_includes</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tree</span>


<span class="k">def</span> <span class="nf">get_file_location</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">basepath</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">location</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">::])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">location</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">location</span>


<span class="k">def</span> <span class="nf">handle_inheritance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Will build a form based on a parent form. Will replace elements</span>
<span class="sd">    overwritten in the inherited form and add new elements.</span>

<span class="sd">    :tree: ElementTree</span>
<span class="sd">    :path: Path of the loaded form</span>
<span class="sd">    :returns: ElementTree</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;inherits&quot;</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tree</span>
    <span class="n">ptree</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">get_file_location</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;inherits&quot;</span><span class="p">],</span> <span class="n">basepath</span><span class="p">))</span>

    <span class="c1"># Workaroutn for missing support of getting parent elements. See</span>
    <span class="c1"># http://stackoverflow.com/</span>
    <span class="c1"># questions/2170610/access-elementtree-node-parent-node/2170994</span>
    <span class="n">tree_parent_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">iter</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">}</span>
    <span class="n">ptree_parent_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ptree</span><span class="o">.</span><span class="n">iter</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">getiterator</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Is there a an element with the same id in the ptree?</span>
        <span class="n">xpath</span> <span class="o">=</span> <span class="s2">&quot;.//*[@id=&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">pelement</span> <span class="o">=</span> <span class="n">ptree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">xpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pelement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Replace the parent element with the one in inherited</span>
            <span class="c1"># element.</span>
            <span class="n">pparent</span> <span class="o">=</span> <span class="n">ptree_parent_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pelement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pindex</span> <span class="o">=</span> <span class="n">pparent</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pelement</span><span class="p">)</span>
                <span class="n">pparent</span><span class="o">.</span><span class="n">_children</span><span class="p">[</span><span class="n">pindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add the element to the parent tree</span>
            <span class="c1"># 1. First get the parent of the new element and get the</span>
            <span class="c1"># same element from the parent tree.</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">tree_parent_map</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="n">xpath</span> <span class="o">=</span> <span class="s2">&quot;.//</span><span class="si">%s</span><span class="s2">[id=&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xpath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="o">.</span><span class="n">tag</span>

            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;configuration&quot;</span><span class="p">:</span>
                <span class="n">ptree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="n">xpath</span> <span class="o">=</span> <span class="s2">&quot;.//</span><span class="si">%s</span><span class="s2">[id=&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                <span class="n">pelement</span> <span class="o">=</span> <span class="n">ptree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">xpath</span><span class="p">)</span>
                <span class="n">pelement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xpath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">pelement</span> <span class="o">=</span> <span class="n">ptree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">xpath</span><span class="p">)</span>
                <span class="n">pelement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="n">ptree</span> <span class="o">=</span> <span class="n">handle_includes</span><span class="p">(</span><span class="n">ptree</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ptree</span>


<span class="k">def</span> <span class="nf">handle_includes</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Will replace all include element with the content of the include</span>
<span class="sd">    file.</span>

<span class="sd">    :tree: ElementTree</span>
<span class="sd">    :path: Path of the loaded form</span>
<span class="sd">    :returns: ElementTree</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Workaroutn for missing support of getting parent elements. See</span>
    <span class="c1"># http://stackoverflow.com/</span>
    <span class="c1"># questions/2170610/access-elementtree-node-parent-node/2170994</span>
    <span class="n">parent_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">iter</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">}</span>
    <span class="c1"># handle includes in form</span>
    <span class="k">for</span> <span class="n">include_placeholder</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//include&quot;</span><span class="p">):</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">include_placeholder</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>
        <span class="n">entity_prefix</span> <span class="o">=</span> <span class="n">include_placeholder</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity-prefix&quot;</span><span class="p">)</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">include_placeholder</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;element&quot;</span><span class="p">)</span>
        <span class="n">include_tree</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">get_file_location</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">basepath</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">entity_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include_tree</span> <span class="o">=</span> <span class="n">handle_entity_prefix</span><span class="p">(</span><span class="n">include_tree</span><span class="p">,</span> <span class="n">entity_prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include_tree</span> <span class="o">=</span> <span class="n">include_tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//*[@id=&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">parent_map</span><span class="p">[</span><span class="n">include_placeholder</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">include_placeholder</span><span class="p">)</span>
        <span class="c1"># Check if the content to be included is wrapped in a</span>
        <span class="c1"># &#39;configuration&#39; section.</span>
        <span class="k">if</span> <span class="n">include_tree</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;configuration&quot;</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_children</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">include_tree</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">_children</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">include_tree</span>
    <span class="k">return</span> <span class="n">tree</span>


<span class="k">def</span> <span class="nf">handle_entity_prefix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>

    <span class="c1"># Collect name of fields which are defined in this form. This is</span>
    <span class="c1"># used as we only want to handle prefixes on fieldname and</span>
    <span class="c1"># expression for fields which are defined in the form.</span>
    <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//entity&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">replace_fieldnames</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">):</span>
        <span class="c1"># TODO: Handle % and @ variables to? (ti) &lt;2015-12-17 09:30&gt;</span>
        <span class="c1"># Note: This algorithmn is hackish and handles some corner cases</span>
        <span class="c1"># with replacements of similar fields names.</span>
        <span class="c1">#</span>
        <span class="c1"># Example:</span>
        <span class="c1"># Consider the following expr = &quot;$foo and $foo_bar&quot; And we want</span>
        <span class="c1"># to add a prefix &quot;baz&quot;.</span>
        <span class="c1">#</span>
        <span class="c1"># The code will iterate over all unique fields in the expression</span>
        <span class="c1"># and replaces the fieldname with prefix+fieldname.</span>
        <span class="c1">#</span>
        <span class="c1"># Problem:</span>
        <span class="c1"># If we start with the longest field name first the in first</span>
        <span class="c1"># iteration the expression looks like this:</span>
        <span class="c1"># $foo and $baz.foo_bar.</span>
        <span class="c1"># With the next iteration on &quot;foo&quot; the expression will look like</span>
        <span class="c1"># this:</span>
        <span class="c1"># $baz.foo and $baz.baz.foo_bar with is obvsisouly wrong because</span>
        <span class="c1"># of the double baz.baz.</span>
        <span class="c1">#</span>
        <span class="c1"># Solution:</span>
        <span class="c1"># To handle this problem we sort the fields in the expression to</span>
        <span class="c1"># start with the shortest fieldname. The the result looks like</span>
        <span class="c1"># this on the first iteration:</span>
        <span class="c1"># $baz.foo and $baz.foo_bar.</span>
        <span class="c1"># Note the replacing &quot;foo&quot; also replaces &quot;foo_bar&quot;.</span>
        <span class="c1"># Now on the next iteration of &quot;foo_bar&quot; we check if there is</span>
        <span class="c1"># already a prefixed version of this in the expression. If so we</span>
        <span class="c1"># ignore the replacement to prevent double prefixes.</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;\$[\.\w]+&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>
            <span class="c1"># Only replace name of fields which has has been defined in</span>
            <span class="c1"># this tree or it is been already replaced.</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fieldnames</span> <span class="ow">or</span> <span class="n">prefix</span><span class="o">+</span><span class="n">field</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">prefix</span><span class="o">+</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span>

    <span class="c1"># Handle fields</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//entity&quot;</span><span class="p">):</span>
        <span class="n">field</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="n">field</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="c1"># Handle rules</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//rule&quot;</span><span class="p">):</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;expr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace_fieldnames</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;expr&quot;</span><span class="p">],</span>
                                                 <span class="n">prefix</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">)</span>
    <span class="c1"># Handle conditional</span>
    <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//if&quot;</span><span class="p">):</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;expr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace_fieldnames</span><span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;expr&quot;</span><span class="p">],</span>
                                                 <span class="n">prefix</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tree</span>


<span class="k">def</span> <span class="nf">flatten_form_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Refacoring helper method. Currently the fields dictionary of the</span>
<span class="sd">    for saves all fields in a dictionary with fields per page. This</span>
<span class="sd">    method will flatten the given given fields dictionary removing</span>
<span class="sd">    the page information. I a root (page) is given only the fields</span>
<span class="sd">    for the given page are returned.</span>

<span class="sd">    TODO: Make this method obsolete by changing the datastructure of the</span>
<span class="sd">    fields dictionary. Save mapping of page2fields in a separate</span>
<span class="sd">    varibale (ti) &lt;2016-01-11 16:44&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmpfields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="n">page</span><span class="p">]:</span>
                <span class="n">tmpfields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">page</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tmpfields</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">page_id</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fields</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">filter_form_fields</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Refacoring helper method. Will a return dictiony of fields which</span>
<span class="sd">    are in &#39;active&#39; conditionals.  Active means the expression in the</span>
<span class="sd">    conditional will evaluate to true using the given set of values.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># FIXME: The only way get only fields which are</span>
    <span class="c1"># relevant (e.g in evaluable conditionals) is to &quot;reinit&quot;</span>
    <span class="c1"># the fields.</span>
    <span class="n">filtered_fields</span> <span class="o">=</span> <span class="n">flatten_form_fields</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">init_fields</span><span class="p">(</span><span class="n">values</span><span class="p">,</span>
                                                           <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">tmp_fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="n">filtered_fields</span><span class="p">:</span>
            <span class="n">tmp_fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
    <span class="k">return</span> <span class="n">tmp_fields</span>


<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../api.html#formbar.config.Config">[docs]</a><span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for accessing the form configuration file. It provides methods to</span>
<span class="sd">    get certain elements from the configuration. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a configuration with the DOM tree of an XML configuration</span>
<span class="sd">        for the form. If tree is not an instance of an ElementTree than raise a</span>
<span class="sd">        TypeError</span>

<span class="sd">        :tree: XML DOM tree of the configuration file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Config must instanciated with a &#39;</span>
                   <span class="s1">&#39;ElementTree.Element instance. &quot;</span><span class="si">%s</span><span class="s1">&quot; was provided&#39;</span> <span class="o">%</span> <span class="n">tree</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all elements found in the tree with the given</span>
<span class="sd">        name. If no elements can be found. Return an empty list.</span>

<span class="sd">        :name: name of the elements to be found</span>
<span class="sd">        :returns: list of elements</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qstr</span> <span class="o">=</span> <span class="s2">&quot;.//</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an ``Element`` from the configuration. If the element can</span>
<span class="sd">        not be found it returns None. If there are more than one element of</span>
<span class="sd">        this name and the id, than raise an KeyException.</span>

<span class="sd">        If the intitail found element refers to another element by the &#39;ref&#39;</span>
<span class="sd">        attribute the function is recalled as long as it can find the element.</span>
<span class="sd">        :name: Name of the element (e.g entity)</span>
<span class="sd">        :id: ID of the element</span>
<span class="sd">        :returns: ``Element`` or ``None``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qstr</span> <span class="o">=</span> <span class="s2">&quot;.//</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
            <span class="n">qstr</span> <span class="o">+=</span> <span class="s2">&quot;[@id=&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="nb">id</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">qstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Element is ambigous </span><span class="si">%s</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If the found elements refernces another element than retry</span>
            <span class="c1"># getting the refed element</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Config.get_form"><a class="viewcode-back" href="../../api.html#formbar.config.Config.get_form">[docs]</a>    <span class="k">def</span> <span class="nf">get_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a :class:`.Form` instance with the configuration for a form</span>
<span class="sd">        with id in the configuration file. If the form can not be found a</span>
<span class="sd">        KeyError is raised.</span>

<span class="sd">        :id: ID of the form in the configuration file</span>
<span class="sd">        :returns: ``FormConfig`` instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;Form with id &quot;</span><span class="si">%s</span><span class="s1">&quot; can not be found&#39;</span> <span class="o">%</span> <span class="nb">id</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Form</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">Form</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for accessing the configuration of a specific form. The form</span>
<span class="sd">    configuration only provides a subset of available attributes for forms.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a form configuration with the DOM tree of a XML form</span>
<span class="sd">        configuration. On initialisation the form will be configured that means</span>
<span class="sd">        that all included fields will be configured.</span>

<span class="sd">        :tree: XML DOM tree of the form configuration.</span>
<span class="sd">        :parent: XML DOM tree of the parent configuration.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="sd">&quot;&quot;&quot;Reference to parent configuration&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;id. ID of the form&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        <span class="sd">&quot;&quot;&quot;Flag to set the form as a readonly form. If set all fields in</span>
<span class="sd">        the form.  will be rendered as a simple textfield which does not</span>
<span class="sd">        allow to change or enter any data. Defaults to False&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">css</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;css. CSS class(es) to be added to the form&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autocomplete</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;autocomplete&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;autocomplete. Configure the form to autocomplete (prefill) the</span>
<span class="sd">        fields in the form. Defaults to &#39;on&#39;&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;method. HTTP method used for sending the data. Defaults to &#39;POST&#39;</span>
<span class="sd">        Valid values are GET and POST.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;action. URL where to send the data. Defaults to an empty string</span>
<span class="sd">        which means send data to the current url again.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enctype</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enctype&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;enctype. Encoding type of the subbmitted values. Use</span>
<span class="sd">        &#39;multipart/form-data&#39; if you want to upload files. Defaults to an empty</span>
<span class="sd">        string.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id2name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with a mapping of id to fieldnames&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="sd">&quot;&quot;&quot;Flag to indicate that the form has been setup&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_buttons</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;Buttons of the form&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with all fields per page in a dictionary.</span>
<span class="sd">        {</span>
<span class="sd">            &quot;p1&quot;: [&lt;formbar.config.Field&gt;, ...],</span>
<span class="sd">            &quot;p2&quot;: [&lt;formbar.config.Field&gt;, ...]</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Get all Buttons for the form.</span>
        <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//button&#39;</span><span class="p">):</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buttons</span>

    <span class="k">def</span> <span class="nf">get_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Get all fields for the form.</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span>

        <span class="c1"># Search for fields</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//page&#39;</span><span class="p">):</span>
            <span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Now search for snippets</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//snippet&#39;</span><span class="p">):</span>
            <span class="n">sref</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sref</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">get_element</span><span class="p">(</span><span class="s1">&#39;snippet&#39;</span><span class="p">,</span> <span class="n">sref</span><span class="p">)</span>
                <span class="n">pages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pages</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pages</span>

    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_layout</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Will walk the tree recursivley and yields every field node.</span>
<span class="sd">        Optionally you can yield every layout elements too.  If evaluate</span>
<span class="sd">        parameter is true, then the function will only return fields</span>
<span class="sd">        which are relevant after the conditionals in the form has been</span>
<span class="sd">        evaluated.</span>

<span class="sd">        :root: Root node</span>
<span class="sd">        :values: Dictionary with values which are used for evaluating</span>
<span class="sd">        conditionals.</span>
<span class="sd">        :evaluate: Flag to indicate if evaluation should be done on</span>
<span class="sd">        conditionals</span>
<span class="sd">        :include_layout: Flag to indicate to include layout elements</span>
<span class="sd">        too.</span>
<span class="sd">        :returns: yields field elements</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;if&quot;</span><span class="p">:</span>
                    <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expr&#39;</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">evaluate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rule</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="c1"># FIXME: This error can happen if the rule</span>
                        <span class="c1"># refers to values which are not contained in</span>
                        <span class="c1"># the provided values dictionary. The value</span>
                        <span class="c1"># might be missing because the converting of the</span>
                        <span class="c1"># value failed or the value was missing at</span>
                        <span class="c1"># all.(e.g the field was a selection field and</span>
                        <span class="c1"># was &quot;disabled&quot; in a conditional. In this case</span>
                        <span class="c1"># the value is not sent. (ti) &lt;2015-04-28 16:52&gt;</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>
                                          <span class="n">evaluate</span><span class="p">,</span> <span class="n">include_layout</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">elem</span>
                <span class="k">elif</span> <span class="n">include_layout</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;section&quot;</span><span class="p">,</span>
                                                      <span class="s2">&quot;subsection&quot;</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="n">child</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>
                                          <span class="n">evaluate</span><span class="p">,</span> <span class="n">include_layout</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">elem</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>
                                          <span class="n">evaluate</span><span class="p">,</span> <span class="n">include_layout</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">elem</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;snippet&quot;</span><span class="p">:</span>
                <span class="n">sref</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sref</span><span class="p">:</span>
                    <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">get_element</span><span class="p">(</span><span class="s1">&#39;snippet&#39;</span><span class="p">,</span> <span class="n">sref</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>
                                          <span class="n">evaluate</span><span class="p">,</span> <span class="n">include_layout</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">elem</span>
            <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">child</span>

    <span class="k">def</span> <span class="nf">init_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Will return the fields in the form as a dictionary. The</span>
<span class="sd">        dicionary will containe all fields per page to make the access</span>
<span class="sd">        to the fields on a page faster (e.g get_errors and get_warnings):</span>

<span class="sd">        {</span>
<span class="sd">            &quot;p1&quot;: [&lt;formbar.config.Field&gt;, ...],</span>
<span class="sd">            &quot;p2&quot;: [&lt;formbar.config.Field&gt;, ...]</span>
<span class="sd">        }</span>

<span class="sd">        Fields fetched by searching all field elements in the form or</span>
<span class="sd">        snippets and &quot;subsnippets&quot; in the forms.</span>

<span class="sd">        The attribute ``values`` and ``evaluate`` are used for</span>
<span class="sd">        evaluating the rules on initialisation to only include relevant</span>
<span class="sd">        fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pages</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="n">page_id</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="n">fields</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">evaluate</span><span class="p">):</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">get_element</span><span class="p">(</span><span class="s1">&#39;entity&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
                <span class="c1"># Inherit readonly flag to all fields in this field.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">page_id</span><span class="p">][</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_id2name</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">{},</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of included fields in the form.</span>

<span class="sd">        :returns: A dictionary with the configured fields in the form.</span>
<span class="sd">        The name of the field is the key of the dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: Move filtering (evaluation) out of this method ()</span>
        <span class="c1"># &lt;2016-01-11 15:33&gt;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_fields</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">flatten_form_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">evaluate</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">filter_form_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the field with the name from the form. If the field can not</span>
<span class="sd">        be found a KeyError is raised.</span>

<span class="sd">        :name: name of the field to get</span>
<span class="sd">        :returns: ``Field``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Tried to get field &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span>
                      <span class="s1">&#39; which is not included in the form&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>


<span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configuration of a Field&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits a field with the entity DOM element.</span>

<span class="sd">        :entity: entity DOM element</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>

        <span class="c1"># Attributes of the field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Id of the field. Usally only used to refer to the field.</span>
<span class="sd">        Example labels.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Name of the field. values will be submitted using this name&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
        <span class="sd">&quot;&quot;&quot;Label of the field. If no label is provied the a capitalized</span>
<span class="sd">        form of the name is used. To not render a label at all define a</span>
<span class="sd">        label with an empty string.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;A ordering number for the field. In some form it is helpfull</span>
<span class="sd">        to be able to refer to a specific field by its number. The</span>
<span class="sd">        number will be rendered next to the label of the field.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The datatype for this field. The data type is important for</span>
<span class="sd">        converting the submitted data into a python value. Note that</span>
<span class="sd">        this option is ignored if the form is used to render an</span>
<span class="sd">        SQLAlchemy mapped item.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;placeholder&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Defines a placeholder for this field that overrides the default</span>
<span class="sd">        placeholder.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">css</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;A string which will be added to the class tag of the form&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        <span class="sd">&quot;&quot;&quot;Flag to mark the field as a required field. If this tag is</span>
<span class="sd">        set an additional rule will be added to the field and an astrix</span>
<span class="sd">        is rendered at the label of the field. Note that this option</span>
<span class="sd">        might not be needed to be set if the form is used to render a</span>
<span class="sd">        SQLAlchemy mapped item as this. In this case the required flag</span>
<span class="sd">        is already set by the underlying FormAlchemy library by checking</span>
<span class="sd">        if the database field is &#39;NOT NULL&#39;. Defaults to False&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">desired</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;desired&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        <span class="sd">&quot;&quot;&quot;Flag to mark the field as a desired field. If this tag is</span>
<span class="sd">        set an additional rule will be added to the field and an star</span>
<span class="sd">        symbol is rendered at the label of the field. Defaults to</span>
<span class="sd">        False&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        <span class="sd">&quot;&quot;&quot;Flag to set the field as a readonly field. If set the field</span>
<span class="sd">        will be rendered as a simple textfield which does not allow to</span>
<span class="sd">        change or enter any data. Defaults to False&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autocomplete</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;autocomplete&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Flag to enable or disable the automcomplete feature for this</span>
<span class="sd">        field. Defaults to enabled autocompletion&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autofocus</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;autofocus&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        <span class="sd">&quot;&quot;&quot;Flag to enable focusing the field on pageload. Note that only</span>
<span class="sd">        one field in the form can have the autofocus attribute.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s2">u&quot;&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Default value of the field. Note that this value might be</span>
<span class="sd">        overwritten while rendering the form if the field is within the</span>
<span class="sd">        submitted values on a form submission. Defaults to empty</span>
<span class="sd">        string. This attribute is also used for Infofields to define the</span>
<span class="sd">        value which should be displayed (If no expression is defined)&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Tags of the field. Fields can have tags. Tags can be used to</span>
<span class="sd">        mark fields in the form and become handy if a application wants</span>
<span class="sd">        to find fields having a specific tag.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c1"># Subelements of the fields</span>
        <span class="c1"># Options (For dropdown, checkbox and radio fields)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;options&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> \
           <span class="ow">and</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
           <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">option</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                                     <span class="n">option</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">),</span>
                                     <span class="n">option</span><span class="o">.</span><span class="n">attrib</span><span class="p">))</span>

        <span class="c1"># Help</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;help&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">help</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help_display</span> <span class="o">=</span> <span class="n">help</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;display&quot;</span><span class="p">,</span> <span class="s2">&quot;tooltip&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="n">help</span><span class="o">.</span><span class="n">text</span>

        <span class="c1"># Renderer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">renderer_config</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;renderer&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">renderer_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renderer</span> <span class="o">=</span> <span class="n">Renderer</span><span class="p">(</span><span class="n">renderer_config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Add automatic genertated rules based on the required or</span>
        <span class="c1"># desired flag</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;bool($</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;pre&quot;</span>
            <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">required_msg</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">desired</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;bool($</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;pre&quot;</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
            <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">desired_msg</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">triggers</span><span class="p">))</span>
        <span class="c1"># Add rules added the the field.</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;rule&#39;</span><span class="p">):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expr&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msg&#39;</span><span class="p">)</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;triggers&#39;</span><span class="p">)</span>
            <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">triggers</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rules</span>


<span class="k">class</span> <span class="nc">Renderer</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configuration class for FieldRenderers. This class gives an</span>
<span class="sd">    interface to the Renderer configuration for fields if the field</span>
<span class="sd">    should be rendererd differently than the standard way.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;@todo: to be defined &quot;&quot;&quot;</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>

        <span class="c1"># Attributes of the Renderer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_type</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Type of the Renderer. Known Renderers:</span>
<span class="sd">        - Datepicker</span>
<span class="sd">        - Textarea</span>
<span class="sd">        - HTML</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements_indent</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;Optional if set the field and help elements will be have a</span>
<span class="sd">        small indent. The value of the attribute defines the style.</span>
<span class="sd">        Currently only applies to the Radio renderer if label alignment</span>
<span class="sd">        is &#39;top&#39;.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent_style</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent_border</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent_width</span> <span class="o">=</span> <span class="s2">&quot;indent-sm&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_indent</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_indent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent_style</span> <span class="o">=</span> <span class="s2">&quot;indent-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">style</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_indent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;bordered&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent_border</span> <span class="o">=</span> <span class="s2">&quot;indent-bordered&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_indent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;lg&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent_width</span> <span class="o">=</span> <span class="s2">&quot;indent-lg&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_indent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;md&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent_width</span> <span class="o">=</span> <span class="s2">&quot;indent-md&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_background</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;Optional. If defined the label will get a light background</span>
<span class="sd">        color&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_position</span> <span class="o">=</span> <span class="s2">&quot;top&quot;</span>
        <span class="sd">&quot;&quot;&quot;Optional. If defined the label will placed left, top</span>
<span class="sd">        or right to the field.  Defaults to top&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_align</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span>
        <span class="sd">&quot;&quot;&quot;Optional. If defined the label will be aligned left or right,</span>
<span class="sd">        Defaults to left This only applies for lables which are</span>
<span class="sd">        positioned on the left or right side&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_width</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="sd">&quot;&quot;&quot;Optional. If defined the label will have the defined width.</span>
<span class="sd">        Defaults to 2 cols. The Fieldwidth will be reduced by the label</span>
<span class="sd">        width. This only applies for lables which are positioned on the</span>
<span class="sd">        left or right side.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span>
        <span class="sd">&quot;&quot;&quot;Optional. Position of the number in the label. Can be `left`</span>
<span class="sd">        or `right`. Defaults to `left`&quot;&quot;&quot;</span>
        <span class="n">label_config</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">label_config</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;left&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_position</span> <span class="o">=</span> <span class="n">label_config</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;top&quot;</span>
            <span class="k">if</span> <span class="n">label_config</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;background&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_background</span> <span class="o">=</span> <span class="s2">&quot;background&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_position</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_align</span> <span class="o">=</span> <span class="n">label_config</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;align&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;right&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_position</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_align</span> <span class="o">=</span> <span class="n">label_config</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;align&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;left&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">label_config</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Warning! The body of the renderer may include all valid and</span>
        <span class="c1"># invalid html data including scripting. Use with caution here as</span>
        <span class="c1"># this may become a large security hole if some users inject</span>
        <span class="c1"># malicious code!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;The body attribute is currently only used by the HTML</span>
<span class="sd">        Renderer and has the content to be rendererd.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_type</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Formbar 0.20.3 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2013, 2014, 2015, 2016 Torsten Irlnder.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>
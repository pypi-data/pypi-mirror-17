

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>VirtualMicrobes.my_tools.utility &mdash; Virtual Microbes Evolutionary Simulator 0.1.3 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Virtual Microbes Evolutionary Simulator 0.1.3 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Virtual Microbes Evolutionary Simulator
          

          
          </a>

          
            
            
              <div class="version">
                0.1.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Virtual Microbes Evolutionary Simulator</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>VirtualMicrobes.my_tools.utility</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for VirtualMicrobes.my_tools.utility</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Created on Oct 22, 2014</span>

<span class="sd">@author: thocu</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">attrdict</span> <span class="k">import</span> <span class="n">AttrDict</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">shelve</span> <span class="k">import</span> <span class="n">Shelf</span><span class="p">,</span> <span class="n">_ClosedDict</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">multiprocessing.queues</span> <span class="k">import</span> <span class="n">SimpleQueue</span> 
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">psutil</span> <span class="c1"># @UnresolvedImport</span>
<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">errand_boy</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
    <span class="kn">from</span> <span class="nn">cPickle</span> <span class="k">import</span> <span class="n">Pickler</span><span class="p">,</span> <span class="n">Unpickler</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="kn">from</span> <span class="nn">pickle</span> <span class="k">import</span> <span class="n">Pickler</span><span class="p">,</span> <span class="n">Unpickler</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="k">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="k">import</span> <span class="n">StringIO</span>

<span class="n">ugly_globals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PhyloLinkerDict&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;UniquePhyloKey&#39;</span><span class="p">:</span><span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> 
                <span class="s1">&#39;graphs_as_subprocesses&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>


<div class="viewcode-block" id="flatten"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.flatten">[docs]</a><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">nested_lists</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">nested_lists</span><span class="p">))</span></div>

<div class="viewcode-block" id="queuedprocessor"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.queuedprocessor">[docs]</a><span class="k">def</span> <span class="nf">queuedprocessor</span><span class="p">(</span><span class="n">as_subprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Decorator that can can cause a decorated method to be returned</span>
<span class="sd">    as a Task tuple, depending on the decorator argument.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">as_subprocess</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Not a subprocesses&#39;</span>
    <span class="k">def</span> <span class="nf">sub_process_wrapper</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">run_subproc</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;run_subproc&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;run_subproc&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">as_subprocess</span> <span class="ow">or</span> <span class="n">run_subproc</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">run_subproc</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;run_subproc&#39;</span><span class="p">]</span>
                <span class="n">f</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> 
            <span class="k">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">sub_process_wrapper</span></div>

<div class="viewcode-block" id="subprocessor"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.subprocessor">[docs]</a><span class="k">def</span> <span class="nf">subprocessor</span><span class="p">(</span><span class="n">as_subprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Decorator that can can cause a decorated function or method to be returned</span>
<span class="sd">    as a subprocess or simply evaluated, depending on the decorator argument.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">as_subprocess</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Not a subprocesses&#39;</span>
    <span class="k">def</span> <span class="nf">sub_process_wrapper</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">as_subprocess</span> <span class="p">:</span>
                <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> 
            <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">sub_process_wrapper</span></div>

<span class="c1"># https://gist.github.com/schlamar/2311116</span>
<div class="viewcode-block" id="processify"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.processify">[docs]</a><span class="k">def</span> <span class="nf">processify</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Decorator to run a function as a process.</span>
<span class="sd">    </span>
<span class="sd">    Be sure that every argument and the return value is *pickable*. The created</span>
<span class="sd">    process is joined, so the code does not run in parallel.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">process_func</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ex_type</span><span class="p">,</span> <span class="n">ex_value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">ex_type</span><span class="p">,</span> <span class="n">ex_value</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">))</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">ret</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>

    <span class="c1"># register original function with different name</span>
    <span class="c1"># in sys.modules so it is pickable</span>
    <span class="n">process_func</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;processify_func&#39;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">__name__</span><span class="p">],</span> <span class="n">process_func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">process_func</span><span class="p">)</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">SimpleQueue</span><span class="p">()</span> <span class="c1"># potential fix for hanging multiprocess Queue http://stackoverflow.com/a/33733764</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">ex_type</span><span class="p">,</span> <span class="n">ex_value</span><span class="p">,</span> <span class="n">tb_str</span> <span class="o">=</span> <span class="n">error</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (in subprocess)</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ex_value</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">tb_str</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ex_type</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<div class="viewcode-block" id="errand_boy_server"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.errand_boy_server">[docs]</a><span class="k">def</span> <span class="nf">errand_boy_server</span><span class="p">():</span>
    <span class="n">socket_base</span><span class="o">=</span><span class="s1">&#39;/tmp/errand-boy&#39;</span>
    <span class="kn">from</span> <span class="nn">errand_boy.transports.unixsocket</span> <span class="k">import</span> <span class="n">UNIXSocketTransport</span>
    <span class="kn">from</span> <span class="nn">errand_boy.run</span> <span class="k">import</span> <span class="n">LOGGING</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">LOGGING</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">time</span>
    
    <span class="n">socket_path</span><span class="p">,</span> <span class="n">socket_index</span> <span class="o">=</span> <span class="n">socket_base</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socket_path</span><span class="p">):</span>
        <span class="n">socket_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">socket_base</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">socket_index</span><span class="p">)])</span>
        <span class="n">socket_index</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="n">transport</span> <span class="o">=</span> <span class="n">UNIXSocketTransport</span><span class="p">(</span><span class="n">socket_path</span><span class="o">=</span><span class="n">socket_path</span><span class="p">)</span>
    <span class="n">server_as_subproc</span> <span class="o">=</span> <span class="n">subprocessor</span><span class="p">(</span><span class="n">as_subprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">transport</span><span class="o">.</span><span class="n">run_server</span><span class="p">)</span>
    <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_tries</span><span class="p">):</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">server_as_subproc</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_accepts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="c1"># the server is still alive after 10 sec</span>
            <span class="c1"># we are ready to &#39;yield&#39;</span>
            <span class="k">break</span>
        <span class="c1"># else, try again</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">proc</span><span class="p">,</span> <span class="n">socket_path</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;killing errand-boy&#39;</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="ensure_dir"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.ensure_dir">[docs]</a><span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remove_globs</span><span class="o">=</span><span class="p">[]):</span>
    <span class="c1">#d = os.path.dirname(f)</span>
    <span class="n">pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">remove_globs</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">d</span><span class="p">,</span> <span class="s2">&quot;exists. Removing files matching&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">remove_globs</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">_dirs</span><span class="p">,</span> <span class="n">_files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">remove_glob</span> <span class="ow">in</span> <span class="n">remove_globs</span><span class="p">:</span>
                    <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">,</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">remove_glob</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">message</span> <span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">d</span><span class="p">,</span> <span class="s2">&quot;exists. Files may be overwritten.&quot;</span>
            <span class="k">if</span> <span class="n">message</span> <span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">message</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span> <span class="c1"># change back to where we started               </span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;could not make dir&#39;</span><span class="p">,</span> <span class="n">d</span>
            <span class="k">raise</span></div>


<span class="c1"># https://gist.github.com/audy/783125</span>
<span class="c1"># Shannon Diversity Index</span>
<span class="c1"># http://en.wikipedia.org/wiki/Shannon_index</span>
<div class="viewcode-block" id="sdi"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.sdi">[docs]</a><span class="k">def</span> <span class="nf">sdi</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given a hash { &#39;species&#39;: count } , returns the SDI</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; sdi({&#39;a&#39;: 10, &#39;b&#39;: 20, &#39;c&#39;: 30,})</span>
<span class="sd">    1.0114042647073518&quot;&quot;&quot;</span>
    
    <span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">ln</span>
    
    <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Relative abundance &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span>  <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">ln</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
            
    <span class="n">N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="padded_most_frequent"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.padded_most_frequent">[docs]</a><span class="k">def</span> <span class="nf">padded_most_frequent</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">freq_cutoff</span><span class="p">):</span>
    <span class="n">most_frequent</span> <span class="o">=</span> <span class="n">unique_count</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="n">freq_cutoff</span><span class="p">]</span>
    <span class="n">most_frequent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">most_frequent</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pad_frequencies</span><span class="p">(</span><span class="n">most_frequent</span><span class="p">,</span> <span class="n">freq_cutoff</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="unique_count"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.unique_count">[docs]</a><span class="k">def</span> <span class="nf">unique_count</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Count values and return value-count pairs sorted on counts (highest first)</span>
<span class="sd">    :param a:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">unique</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">counted_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="n">unique</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">counted_array</span><span class="p">[</span><span class="n">counted_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>
        
<div class="viewcode-block" id="pad_frequencies"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.pad_frequencies">[docs]</a><span class="k">def</span> <span class="nf">pad_frequencies</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">pad_to</span><span class="p">,</span> <span class="n">pad_with</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">pad_to</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="mi">0</span><span class="p">)),</span>                   
                  <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">pad_with</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="time_course_array"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.time_course_array">[docs]</a><span class="k">def</span> <span class="nf">time_course_array</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>

<div class="viewcode-block" id="grow_array"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.grow_array">[docs]</a><span class="k">def</span> <span class="nf">grow_array</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.25</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">ar</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span><span class="p">),</span> <span class="p">))</span></div>

<span class="c1"># http://stackoverflow.com/a/18348004   </span>
<div class="viewcode-block" id="namedtuple_with_defaults"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.namedtuple_with_defaults">[docs]</a><span class="k">def</span> <span class="nf">namedtuple_with_defaults</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">default_values</span><span class="o">=</span><span class="p">()):</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">field_names</span><span class="p">)</span>
    <span class="n">T</span><span class="o">.</span><span class="n">__new__</span><span class="o">.</span><span class="n">__defaults__</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_values</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
        <span class="n">prototype</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="o">**</span><span class="n">default_values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prototype</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="o">*</span><span class="n">default_values</span><span class="p">)</span>
    <span class="n">T</span><span class="o">.</span><span class="n">__new__</span><span class="o">.</span><span class="n">__defaults__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">T</span></div>

 
<span class="n">ReactionScheme</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ReactionScheme&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;reactants&#39;</span><span class="p">,</span> <span class="s1">&#39;products&#39;</span><span class="p">])</span>
     
<span class="n">Coord</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Coord&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span> 

<span class="n">GridPos</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;GridPos&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">])</span> 

<span class="n">PopulationWipe</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;PopulationWipe&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">])</span>

<span class="n">GeneTypeNumbers</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;GeneTypeNumbers&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tf&#39;</span><span class="p">,</span> <span class="s1">&#39;enz&#39;</span><span class="p">,</span> <span class="s1">&#39;pump&#39;</span><span class="p">])</span>

<span class="n">ParamSpace</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ParamSpace&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">])</span>

<span class="n">MutationParamSpace</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;MutationParamSpace&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">])</span>

<span class="n">GridSubDiv</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;GridSubDiv&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">])</span>

<span class="n">SubEnv</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;SubEnv&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;influx_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_grid&#39;</span><span class="p">])</span>

<span class="n">MutationRates</span> <span class="o">=</span> <span class="n">namedtuple_with_defaults</span><span class="p">(</span><span class="s1">&#39;MutationRates&#39;</span><span class="p">,</span> <span class="p">[</span>
                                             <span class="s1">&#39;chrom_dup&#39;</span><span class="p">,</span> 
                                             <span class="s1">&#39;chrom_del&#39;</span><span class="p">,</span> 
                                             <span class="s1">&#39;chrom_fiss&#39;</span><span class="p">,</span> 
                                             <span class="s1">&#39;chrom_fuse&#39;</span><span class="p">,</span> 
                                             <span class="s1">&#39;point_mutation&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;tandem_dup&#39;</span><span class="p">,</span> 
                                             <span class="s1">&#39;stretch_del&#39;</span><span class="p">,</span> 
                                             <span class="s1">&#39;stretch_invert&#39;</span><span class="p">,</span> 
                                             <span class="s1">&#39;stretch_translocate&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;stretch_exp_lambda&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;external_hgt&#39;</span> <span class="p">,</span> 
                                             <span class="s1">&#39;internal_hgt&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;regulatory_mutation&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;reg_stretch_exp_lambda&#39;</span><span class="p">],</span>
                                         <span class="p">{</span><span class="s1">&#39;regulatory_mutation&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="c1"># defaults for new fields, to allow loading older pickles without this definition</span>
                                             <span class="s1">&#39;reg_stretch_exp_lambda&#39;</span><span class="p">:</span><span class="mf">0.02</span><span class="p">}</span>
                                         <span class="p">)</span>
<span class="n">PointMutationRatios</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;PointMutationRatios&#39;</span><span class="p">,</span> <span class="p">[</span>
                                                         <span class="s1">&#39;v_max&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;ene_ks&#39;</span><span class="p">,</span> 
                                                         <span class="s1">&#39;subs_ks&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;exporting&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;promoter&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;operator&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;eff_bound&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;eff_apo&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;ligand_ks&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;k_bind_op&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;ligand_class&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;bind&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;sense_external&#39;</span>
                                                         <span class="p">])</span>
<span class="n">RegulatorytMutationRatios</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RegulatorytMutationRatios&#39;</span><span class="p">,</span> <span class="p">[</span>
                                                                     <span class="s1">&#39;translocate&#39;</span><span class="p">,</span>
                                                                     <span class="s1">&#39;random_insert&#39;</span>
                                                                     <span class="p">])</span>

<span class="n">ETEtreeStruct</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ETEtreeStruct&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">,</span> 
                                             <span class="s1">&#39;named_node_dict&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;node_name_to_phylo_node&#39;</span>
                                             <span class="p">])</span>

<span class="c1">#http://stackoverflow.com/a/1275088</span>
<div class="viewcode-block" id="Struct"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.Struct">[docs]</a><span class="k">def</span> <span class="nf">Struct</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">iargs</span><span class="p">,</span> <span class="o">**</span><span class="n">ikwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iargs</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">iargs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ikwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;MyStruct&quot;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;__init__&#39;</span><span class="p">:</span> <span class="n">init</span><span class="p">,</span> <span class="s1">&#39;__slots__&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span></div>

<span class="n">SmallMol</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="s1">&#39;influx&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;concentration&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;diffusion&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;degradation&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;time_course&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;cum_time_course&#39;</span><span class="p">,</span>  
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SmallMol&#39;</span><span class="p">)</span>
<span class="n">GeneProduct</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">(</span><span class="s1">&#39;concentration&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;diffusion&#39;</span><span class="p">,</span> 
                     <span class="s1">&#39;degradation&#39;</span><span class="p">,</span> 
                     <span class="s1">&#39;time_course&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;cum_time_course&#39;</span><span class="p">,</span> 
                     <span class="s1">&#39;multiplicity&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;GeneProduct&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ReusableIndexDict"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.ReusableIndexDict">[docs]</a><span class="k">class</span> <span class="nc">ReusableIndexDict</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="n">class_version</span> <span class="o">=</span> <span class="s1">&#39;0.0&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[],</span> <span class="n">fixed_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">randomized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">class_version</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">randomized</span> <span class="o">=</span> <span class="n">randomized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_rand_gen</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fixed_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fixed_length</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;setting fixed_length: </span><span class="si">{0}</span><span class="s1"> &lt; len(keys):</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fixed_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">filled_indices</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fixed_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fixed_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filled_indices</span><span class="p">))):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filled_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rand_gen</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    
<div class="viewcode-block" id="ReusableIndexDict.init_rand_gen"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.ReusableIndexDict.init_rand_gen">[docs]</a>    <span class="k">def</span> <span class="nf">init_rand_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rand_gen</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="ReusableIndexDict.index_key"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.ReusableIndexDict.index_key">[docs]</a>    <span class="k">def</span> <span class="nf">index_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unfilled_indices</span> <span class="o">=</span> <span class="p">(</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filled_indices</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomized</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rand_gen</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unfilled_indices</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">unfilled_indices</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">index_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filled_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">StopIteration</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filled_indices</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filled_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">index_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">i</span></div>
            
<div class="viewcode-block" id="ReusableIndexDict.remove_key"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.ReusableIndexDict.remove_key">[docs]</a>    <span class="k">def</span> <span class="nf">remove_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filled_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  </div>
        
<div class="viewcode-block" id="ReusableIndexDict.keys"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.ReusableIndexDict.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="ReusableIndexDict.upgrade"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.ReusableIndexDict.upgrade">[docs]</a>    <span class="k">def</span> <span class="nf">upgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Upgrading from older pickled version of class to latest version. Version</span>
<span class="sd">        information is saved as class variable and should be updated when class</span>
<span class="sd">        invariants (e.g. fields) are added. </span>
<span class="sd">        Adapted from recipe at http://code.activestate.com/recipes/521901-upgradable-pickles/</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_version</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_version</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s1">&#39;upgraded class&#39;</span><span class="p">,</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;reset class&#39;</span><span class="p">,</span> 
        <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s1">&#39; from version&#39;</span><span class="p">,</span> <span class="n">version</span> <span class="p">,</span><span class="s1">&#39;to version&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span></div>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">odict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">odict</span>
        
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="n">d</span>
        <span class="c1"># upgrade class if it has an older version</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;0.0&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upgrade</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="get_unique_key"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.get_unique_key">[docs]</a><span class="k">def</span> <span class="nf">get_unique_key</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">_unique_key</span></div>

<div class="viewcode-block" id="get_from_linker"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.get_from_linker">[docs]</a><span class="k">def</span> <span class="nf">get_from_linker</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ugly_globals</span><span class="p">[</span><span class="s1">&#39;PhyloLinkerDict&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span></div>

<span class="n">map_forward_func</span> <span class="o">=</span> <span class="n">get_unique_key</span>
<span class="n">map_backward_func</span> <span class="o">=</span> <span class="n">get_from_linker</span>


<div class="viewcode-block" id="LinkThroughSequence"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSequence">[docs]</a><span class="k">class</span> <span class="nc">LinkThroughSequence</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A list that applies an arbitrary element</span>
<span class="sd">    function before returning and storing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the class&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ii</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list item&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">map_backward_func</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ii</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete an item&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_forward_func</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">map_forward_func</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__contains__</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_pickle_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[:]</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_unpickle_repr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pickle_repr</span><span class="p">):</span>
        <span class="n">new_lts</span> <span class="o">=</span> <span class="n">LinkThroughSequence</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pickle_repr</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSequence</span><span class="p">,</span> <span class="n">new_lts</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_lts</span>
        
<div class="viewcode-block" id="LinkThroughSequence.pop"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSequence.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map_backward_func</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="LinkThroughSequence.append"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSequence.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">map_forward_func</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinkThroughSequence.insert"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSequence.insert">[docs]</a>    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">map_forward_func</span><span class="p">(</span><span class="n">val</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="LinkThroughSequence.remove"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSequence.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">map_forward_func</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">val</span><span class="p">)</span></div>
        
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSequence</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__iter__</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">map_backward_func</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> </div>

<div class="viewcode-block" id="linkthrough"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.linkthrough">[docs]</a><span class="k">def</span> <span class="nf">linkthrough</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">cf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cf</span></div>

<div class="viewcode-block" id="LinkThroughSet"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet">[docs]</a><span class="k">class</span> <span class="nc">LinkThroughSet</span><span class="p">(</span><span class="nb">set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dictionary that applies an arbitrary key-altering</span>
<span class="sd">       function before accessing the keys&quot;&quot;&quot;</span>
    
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[]):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSet</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

<div class="viewcode-block" id="LinkThroughSet.add"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSet</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">map_forward_func</span><span class="p">(</span><span class="n">el</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="LinkThroughSet.pop"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map_backward_func</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSet</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span></div>
    
<div class="viewcode-block" id="LinkThroughSet.copy"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="nd">@linkthrough</span>
    <span class="k">def</span> <span class="nf">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="nd">@linkthrough</span>
    <span class="k">def</span> <span class="nf">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    
    <span class="nd">@linkthrough</span>
    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="nd">@linkthrough</span>
    <span class="k">def</span> <span class="nf">__iand__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">__iand__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="nd">@linkthrough</span>
    <span class="k">def</span> <span class="nf">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="nd">@linkthrough</span>
    <span class="k">def</span> <span class="nf">__ixor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">__ixor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="nd">@linkthrough</span>
    <span class="k">def</span> <span class="nf">__ior__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">__ior__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>        

    <span class="nd">@linkthrough</span>    
<div class="viewcode-block" id="LinkThroughSet.update"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSet</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

    <span class="nd">@linkthrough</span>        
<div class="viewcode-block" id="LinkThroughSet.difference"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.difference">[docs]</a>    <span class="k">def</span> <span class="nf">difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>

    <span class="nd">@linkthrough</span>    
<div class="viewcode-block" id="LinkThroughSet.intersection"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.intersection">[docs]</a>    <span class="k">def</span> <span class="nf">intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>
    
    <span class="nd">@linkthrough</span>        
<div class="viewcode-block" id="LinkThroughSet.difference_update"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.difference_update">[docs]</a>    <span class="k">def</span> <span class="nf">difference_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>

    <span class="nd">@linkthrough</span>
<div class="viewcode-block" id="LinkThroughSet.symmetric_difference"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.symmetric_difference">[docs]</a>    <span class="k">def</span> <span class="nf">symmetric_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>

    <span class="nd">@linkthrough</span>
<div class="viewcode-block" id="LinkThroughSet.union"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.LinkThroughSet.union">[docs]</a>    <span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSet</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__iter__</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">map_backward_func</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>    
    
                    
    <span class="k">def</span> <span class="nf">_pickle_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method used to create a pickle representation that does not lookup the</span>
<span class="sd">        &#39;linked-through&#39; values in this container. This makes it possible to </span>
<span class="sd">        pickle an object which uses this container without going into deep </span>
<span class="sd">        recursion. Moreover, this makes it usefull to keep such objects in a </span>
<span class="sd">        Shelf like container themselves and &#39;partially&#39; sync them to a the </span>
<span class="sd">        shelf database, without incuring the cost of doing lookups of linked-through</span>
<span class="sd">        objects that reside in the shelf (requiring unpickling those).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span> <span class="p">[</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSet</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()])</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_unpickle_repr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pickle_repr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This is the reverse of forming a _pickle_repr. It recasts the pickle_repr</span>
<span class="sd">        into a fully functional link-through container that has the map_forward and </span>
<span class="sd">        map_backward functionality. </span>
<span class="sd">        :param cls:</span>
<span class="sd">        :param pickle_repr:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new_lts</span> <span class="o">=</span> <span class="n">LinkThroughSet</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pickle_repr</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">LinkThroughSet</span><span class="p">,</span> <span class="n">new_lts</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_lts</span></div>
    
<div class="viewcode-block" id="PartialLinkThroughDict"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.PartialLinkThroughDict">[docs]</a><span class="k">class</span> <span class="nc">PartialLinkThroughDict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Values objects can have a &#39;_unique_key&#39; attribute, in which case storage of the value is </span>
<span class="sd">    linked through to the linker_dict. Otherwise, the value goes into the local storage of the</span>
<span class="sd">    PartialLinkThroughDict instance.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linker_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">larder</span> <span class="o">=</span> <span class="n">linker_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>  <span class="c1"># use the free update to set keys</span>
        
<div class="viewcode-block" id="PartialLinkThroughDict.set_larder"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.PartialLinkThroughDict.set_larder">[docs]</a>    <span class="k">def</span> <span class="nf">set_larder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">larder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">larder</span> <span class="o">=</span> <span class="n">larder</span></div>
        
<div class="viewcode-block" id="PartialLinkThroughDict.close_larder"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.PartialLinkThroughDict.close_larder">[docs]</a>    <span class="k">def</span> <span class="nf">close_larder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">larder</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>
        
<div class="viewcode-block" id="PartialLinkThroughDict.partial_sync"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.PartialLinkThroughDict.partial_sync">[docs]</a>    <span class="k">def</span> <span class="nf">partial_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">larder</span><span class="p">,</span> <span class="n">FIFOLarder</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">larder</span><span class="o">.</span><span class="n">partial_sync</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">larder</span><span class="p">,</span> <span class="n">Shelf</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s1">&#39;full sync in Shelf ojbect&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">larder</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">larder</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;_unique_key&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">_unique_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_unique_key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">larder</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">_unique_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">larder</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">)</span></div>

<span class="c1">#TODO: give option to use a standard dictionary instead of a Shelf like database. </span>
<span class="c1"># At the moment, the FIFOLarder does not serve a function, as there is no partial </span>
<span class="c1"># shelving taking place.             </span>
<div class="viewcode-block" id="FIFOLarder"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FIFOLarder">[docs]</a><span class="k">class</span> <span class="nc">FIFOLarder</span><span class="p">(</span><span class="n">Shelf</span><span class="p">):</span> 
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Maintain a hybrid cached/pickled dictionary that presents as a normal dictionary.</span>
<span class="sd">    Postpone pickling of dictionary values until (partial)sync calls. This requires both</span>
<span class="sd">    the pickled and the cached dict to be checked when lookup en set operations are applied.</span>
<span class="sd">    The cache is an OrderedDict so that it can be &#39;partially&#39; synced to pickle in FIFO order.</span>
<span class="sd">    This structure is usefull when new data coming in is still handled often and may regularly change, </span>
<span class="sd">    while old data can be considered more stable and less likely to change, and thus amenable for more</span>
<span class="sd">    permanent storage.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">anydbm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="n">anydbm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="c1">#self.writeback = True # implementation assumes writeback = True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        
<div class="viewcode-block" id="FIFOLarder.reopen_db"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FIFOLarder.reopen_db">[docs]</a>    <span class="k">def</span> <span class="nf">reopen_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">anydbm</span>
        <span class="k">if</span> <span class="n">save_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_filename</span>
        <span class="c1">#print &#39;reopening FIFOLarder file&#39;, save_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_filename</span> <span class="o">=</span> <span class="n">save_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="n">anydbm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="FIFOLarder.keys"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FIFOLarder.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="FIFOLarder.has_key"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FIFOLarder.has_key">[docs]</a>    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> 

<div class="viewcode-block" id="FIFOLarder.get"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FIFOLarder.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">default</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Unpickler</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_setitem_pickled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1">#print key, &#39;to pickle dict&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Pickler</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">found</span> <span class="o">|=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_protocol&#39;</span><span class="p">):</span>
            <span class="c1">#__init__ didn&#39;t succeed, so don&#39;t bother closing</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="FIFOLarder.sync"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FIFOLarder.sync">[docs]</a>    <span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partial_sync</span><span class="p">(</span><span class="n">part</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="FIFOLarder.close"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FIFOLarder.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="s1">&#39;sync&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Catch errors that may happen when close is called from __del__</span>
        <span class="c1"># because CPython is in interpreter shutdown.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="n">_ClosedDict</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">NameError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="kc">None</span></div>
        
<div class="viewcode-block" id="FIFOLarder.partial_sync"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FIFOLarder.partial_sync">[docs]</a>    <span class="k">def</span> <span class="nf">partial_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        sync a part of the dict to the pickled representation.</span>
<span class="sd">        </span>
<span class="sd">        @param part: can be an int or a float, specifying how much of cache will be </span>
<span class="sd">        synced in FIFO order.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cache_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">nr_items</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span><span class="o">*</span><span class="n">part</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nr_items</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">):</span> <span class="c1">#reversed(self.cache) ):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">nr_items</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setitem_pickled</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
                <span class="n">selected</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="s1">&#39;sync&#39;</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s1">&#39;pickled&#39;</span><span class="p">,</span> <span class="n">selected</span><span class="p">,</span> <span class="s1">&#39;items, decreasing cash by&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reopen_db</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="open_fifolarder"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.open_fifolarder">[docs]</a><span class="k">def</span> <span class="nf">open_fifolarder</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">FIFOLarder</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span> </div>

<span class="c1"># http://stackoverflow.com/a/16551730</span>
<div class="viewcode-block" id="multifile"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.multifile">[docs]</a><span class="k">class</span> <span class="nc">multifile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="n">files</span>
    
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">g</span>
    
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#print &#39;returning self on enter&#39;</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span></div>
                
<span class="c1"># http://stackoverflow.com/a/16085543</span>
<span class="c1"># http://stackoverflow.com/a/9948173</span>
<div class="viewcode-block" id="FormatMessageFile"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FormatMessageFile">[docs]</a><span class="k">class</span> <span class="nc">FormatMessageFile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span> 
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">replace_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\b</span><span class="s1">&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                      <span class="s1">r&#39;\x1b\[([0-9,A-Z]{1,2}(;[0-9]{1,2})?(;[0-9]</span><span class="si">{3}</span><span class="s1">)?)?[m|K]?&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FormatMessageFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_patterns_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1"># NOTE: unordered ok</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">replace_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replace_patterns_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span>
        <span class="nb">print</span> <span class="s1">&#39;using regex replace to format messages for file&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        
    <span class="k">def</span> <span class="nf">_subs_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_patterns_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span>
        
<div class="viewcode-block" id="FormatMessageFile.write"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.FormatMessageFile.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs_patterns</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FormatMessageFile</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div></div>

<span class="c1">#http://stackoverflow.com/a/25109391</span>
<div class="viewcode-block" id="as_attrdict"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.as_attrdict">[docs]</a><span class="k">def</span> <span class="nf">as_attrdict</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AttrDict</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;cannot encode type </span><span class="si">{0}</span><span class="s1">, so skipping it&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
        <span class="k">return</span>
        <span class="c1">#raise TypeError(&#39;not AttrDict but {0}&#39;.format(type(val)))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span></div>

<div class="viewcode-block" id="pickles_adict"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.pickles_adict">[docs]</a><span class="k">class</span> <span class="nc">pickles_adict</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">pickles_adict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="roulette_wheel_draw"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.roulette_wheel_draw">[docs]</a><span class="k">def</span> <span class="nf">roulette_wheel_draw</span><span class="p">(</span><span class="n">events_rel_chances</span><span class="p">,</span> <span class="n">rand_nr</span><span class="p">,</span> <span class="n">non</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="n">total_competition_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="n">events_rel_chances</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">total_competition_value</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;No competition value in any competitor&#39;</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">rand_nr</span> <span class="o">*</span> <span class="p">(</span> <span class="n">total_competition_value</span> <span class="o">+</span> <span class="n">non</span> <span class="p">)</span>
    <span class="n">cumulative_competition</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">event</span><span class="p">,</span> <span class="n">competition_value</span> <span class="p">,</span><span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events_rel_chances</span><span class="p">):</span>
        <span class="n">cumulative_competition</span> <span class="o">+=</span> <span class="n">p</span>
        <span class="k">if</span> <span class="n">rand</span> <span class="o">&lt;=</span> <span class="n">cumulative_competition</span><span class="p">:</span>
            <span class="n">event</span><span class="p">,</span> <span class="n">competition_value</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span>       
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="n">competition_value</span><span class="p">,</span> <span class="n">index</span></div>

<div class="viewcode-block" id="CircularList"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.CircularList">[docs]</a><span class="k">class</span> <span class="nc">CircularList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A list that wraps around instead of throwing an index error.</span>
<span class="sd">    </span>
<span class="sd">    Works like a regular list:</span>
<span class="sd">    &gt;&gt;&gt; cl = CircularList([1,2,3])</span>
<span class="sd">    &gt;&gt;&gt; cl</span>
<span class="sd">    [1, 2, 3]</span>
<span class="sd">    &gt;&gt;&gt; cl[0]</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; cl[-1]</span>
<span class="sd">    3</span>
<span class="sd">    &gt;&gt;&gt; cl[2]</span>
<span class="sd">    3</span>
<span class="sd">    Except wraps around:</span>
<span class="sd">    &gt;&gt;&gt; cl[3]</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; cl[-4]</span>
<span class="sd">    3</span>
<span class="sd">    Slices work</span>
<span class="sd">    &gt;&gt;&gt; cl[0:2]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">_get_slices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slc</span><span class="p">):</span>
        <span class="c1">#print slc.start, slc.stop</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__len__</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">slc</span><span class="p">]</span>
        
        <span class="n">i_quot</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">slc</span><span class="o">.</span><span class="n">start</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span> <span class="p">)</span> 
        <span class="n">j_quot</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">slc</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span> <span class="p">)</span> <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">stop</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1">#print i_quot, i</span>
        <span class="c1">#print j_quot, j</span>
        
        <span class="k">if</span> <span class="n">i_quot</span> <span class="o">==</span> <span class="n">j_quot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
                <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">j_quot</span> <span class="o">&gt;</span> <span class="n">i_quot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span> 
            <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">slices</span>
    
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slices</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">CircularList</span><span class="p">(</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">[</span> <span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">slc</span><span class="p">)</span> <span class="k">for</span> <span class="n">slc</span> <span class="ow">in</span> <span class="n">slices</span> <span class="p">],</span> <span class="p">[]</span> <span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span>
    
    <span class="k">def</span> <span class="nf">__getslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slices</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">slices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[:]</span>
                <span class="k">for</span> <span class="n">slc</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
                    <span class="n">part_list</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">slc</span><span class="p">)</span>
                    <span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">slc</span><span class="p">,</span> <span class="n">val</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">part_list</span><span class="p">)])</span>
                    <span class="k">del</span> <span class="n">val</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">part_list</span><span class="p">)]</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
    
    <span class="k">def</span> <span class="nf">__setslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">seq</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">seq</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">slc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slices</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="nb">list</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
            
    <span class="k">def</span> <span class="nf">__delslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CircularList</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[:]</span>
    
    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CircularList</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">CircularList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">(</span><span class="n">memo</span><span class="p">))</span></div>
         
<div class="viewcode-block" id="OrderedDefaultdict"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.OrderedDefaultdict">[docs]</a><span class="k">class</span> <span class="nc">OrderedDefaultdict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;first argument must be callable or None&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OrderedDefaultdict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__missing__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># optional, for pickle support</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span><span class="p">,</span>
        <span class="c1">#args = tuple() #test</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">args</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span></div>
    

<div class="viewcode-block" id="OrderedSet"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.OrderedSet">[docs]</a><span class="k">class</span> <span class="nc">OrderedSet</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">MutableSet</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="n">end</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>         <span class="c1"># sentinel node for doubly linked list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{}</span>                   <span class="c1"># key --&gt; [key, prev, next]</span>
        <span class="k">if</span> <span class="n">iterable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">|=</span> <span class="n">iterable</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span>

<div class="viewcode-block" id="OrderedSet.add"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.OrderedSet.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">curr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span></div>

<div class="viewcode-block" id="OrderedSet.discard"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.OrderedSet.discard">[docs]</a>    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">:</span>        
            <span class="n">key</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="nb">next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">prev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span>
            <span class="nb">next</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">curr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">curr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="OrderedSet.pop"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.OrderedSet.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;set is empty&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">last</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">OrderedSet</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>

<div class="viewcode-block" id="Consumer"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.Consumer">[docs]</a><span class="k">class</span> <span class="nc">Consumer</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Consumer Process that gets jobs from a Queue until receiving a</span>
<span class="sd">    &#39;poison pill&#39; job that will terminate the process.</span>
<span class="sd">    </span>
<span class="sd">    Jobs will timeout after a given time. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_queue</span><span class="p">,</span> <span class="n">result_queue</span><span class="p">,</span> <span class="n">task_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span> <span class="o">=</span> <span class="n">task_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span> <span class="o">=</span> <span class="n">result_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">task_timeout</span>

<div class="viewcode-block" id="Consumer.run"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.Consumer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">proc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">next_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="c1">#next_task = self.task_queue.pop(0)</span>
            <span class="k">if</span> <span class="n">next_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Poison pill means shutdown</span>
                <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: Exiting&#39;</span> <span class="o">%</span> <span class="n">proc_name</span>
                <span class="c1">#self.task_queue.task_done()</span>
                <span class="k">break</span>
            <span class="c1">#print &#39;%s: %s&#39; % (proc_name, next_task)</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">timeout</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
                    <span class="n">answer</span> <span class="o">=</span> <span class="n">next_task</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;process&#39;</span><span class="p">,</span> <span class="n">proc_name</span><span class="p">,</span> <span class="s1">&#39;timed out&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="k">return</span></div></div>

<div class="viewcode-block" id="Task"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.Task">[docs]</a><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Task object class used to present jobs to Consumer processes. Tasks are</span>
<span class="sd">    assumed to be method functions associated with a class instance.</span>
<span class="sd">    </span>
<span class="sd">    Task will except all errors generated by the method call so that the</span>
<span class="sd">    Consumer processing the Task will stay alive.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">()):</span> <span class="c1"># NOTE: unordered ok</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">func_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;start Task&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">run_subproc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;function:</span><span class="si">{}</span><span class="s1"> args:</span><span class="si">{}</span><span class="s1"> kwargs:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="timeout"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.timeout">[docs]</a><span class="k">class</span> <span class="nc">timeout</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;Timeout&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span>
<div class="viewcode-block" id="timeout.handle_timeout"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.timeout.handle_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">handle_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_timeout</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="detect_rel_path_change"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.detect_rel_path_change">[docs]</a><span class="k">def</span> <span class="nf">detect_rel_path_change</span><span class="p">(</span><span class="n">old_save_dir</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> 
                           <span class="n">mount_path_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                           <span class="n">abs_root</span><span class="o">=</span><span class="s1">&#39;/linuxhome/tmp/&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects the usage of a mounted path versus the abolute path on the server.</span>
<span class="sd">    </span>
<span class="sd">    old_save_dir : path</span>
<span class="sd">        Original simulation save path</span>
<span class="sd">    load_file : file_path</span>
<span class="sd">        Full path of the load file</span>
<span class="sd">    mount_path_depth : path</span>
<span class="sd">        </span>
<span class="sd">    :param abs_root:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">load_file_path</span><span class="p">,</span> <span class="n">lf_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">load_file</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">load_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">load_file_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">mount_path_depth</span><span class="p">:</span>
        <span class="c1"># load_file can not be at mount_path</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">abs_load_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abs_root</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">load_file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="n">mount_path_depth</span><span class="p">:]))</span>
    <span class="n">abs_load_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abs_load_path</span><span class="p">,</span> <span class="n">lf_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">load_file</span><span class="p">,</span> <span class="n">abs_load_file</span><span class="p">):</span> 
            <span class="c1"># We are still running on the same machine</span>
            <span class="k">if</span> <span class="n">old_save_dir</span> <span class="o">==</span> <span class="n">abs_load_path</span><span class="p">:</span>
                <span class="c1"># we are still in the same simulation dir</span>
                <span class="k">return</span> <span class="kc">True</span>
                <span class="c1">#return abs_root, os.path.join(os.sep, </span>
                <span class="c1">#                              *(load_file_path.split(os.sep)[:mount_path_depth]))</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>
        <span class="c1"># The file is not on the &#39;assumed&#39; absolute path</span>


<div class="viewcode-block" id="same_content"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.same_content">[docs]</a><span class="k">def</span> <span class="nf">same_content</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">dir2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare two directory trees content.</span>
<span class="sd">    Return False if they differ, True if they are the same.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span> <span class="s1">&#39;Comparing content of path</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> to </span><span class="se">\n</span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">dir2</span><span class="p">)</span>
    <span class="n">compared</span> <span class="o">=</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">dircmp</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">dir2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">compared</span><span class="o">.</span><span class="n">left_only</span> <span class="ow">or</span> <span class="n">compared</span><span class="o">.</span><span class="n">right_only</span> <span class="ow">or</span> <span class="n">compared</span><span class="o">.</span><span class="n">diff_files</span> 
        <span class="ow">or</span> <span class="n">compared</span><span class="o">.</span><span class="n">funny_files</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">compared</span><span class="o">.</span><span class="n">common_dirs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">same_content</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">subdir</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir2</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="detect_sim_folder_move"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.detect_sim_folder_move">[docs]</a><span class="k">def</span> <span class="nf">detect_sim_folder_move</span><span class="p">(</span><span class="n">stored_save_dir</span><span class="p">,</span> <span class="n">load_path</span><span class="p">):</span>  
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect whether the load_path was placed in a different location from the</span>
<span class="sd">    original simulation path.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stored_save_dir : path</span>
<span class="sd">        original simulation directory</span>
<span class="sd">    load_path : path</span>
<span class="sd">        load file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stored_save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">stored_save_dir</span><span class="p">)</span>
    <span class="n">current_save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">load_path</span><span class="p">)</span>
    <span class="n">path_name_change</span> <span class="o">=</span> <span class="n">stored_save_dir</span> <span class="o">!=</span> <span class="n">current_save_dir</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">differing_content</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">same_content</span><span class="p">(</span><span class="n">stored_save_dir</span><span class="p">,</span> <span class="n">current_save_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="c1"># We do not know the location of the stored_save_dir</span>
        <span class="n">differing_content</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">path_name_change</span><span class="p">,</span> <span class="n">differing_content</span></div>

<div class="viewcode-block" id="kill_proc_tree"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.kill_proc_tree">[docs]</a><span class="k">def</span> <span class="nf">kill_proc_tree</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">including_parent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>    
    <span class="n">parent</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> 
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">psutil</span><span class="o">.</span><span class="n">wait_procs</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">including_parent</span><span class="p">:</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">parent</span></div>
                
<div class="viewcode-block" id="ValueNotInRange"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.ValueNotInRange">[docs]</a><span class="k">class</span> <span class="nc">ValueNotInRange</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="within_range"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.within_range">[docs]</a><span class="k">def</span> <span class="nf">within_range</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">rng</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValueNotInRange</span></div>

<div class="viewcode-block" id="json_dumper"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.json_dumper">[docs]</a><span class="k">def</span> <span class="nf">json_dumper</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># http://stackoverflow.com/a/28174796</span>
    <span class="c1">#try:</span>
    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">toJSON</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="c1">#except AttributeError:</span>
    <span class="c1">#    return obj.__dict__</span>
<span class="c1">#print json.dumps(some_big_object, default=dumper, indent=2)</span>

<div class="viewcode-block" id="chunks"><a class="viewcode-back" href="../../../reference/VirtualMicrobes.my_tools.html#VirtualMicrobes.my_tools.utility.chunks">[docs]</a><span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Yield successive n-sized chunks from l.&#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">]</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Thomas Cuypers, Bram van Dijk.
      Last updated on Oct 10, 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>
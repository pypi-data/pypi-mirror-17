

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ts2img &mdash; imgtsimg 0.1.post0.dev15+g4937be2.dirty documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="imgtsimg 0.1.post0.dev15+g4937be2.dirty documentation" href="index.html"/>
        <link rel="next" title="License" href="license.html"/>
        <link rel="prev" title="repurpose" href="index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="index.html" class="fa fa-home"> imgtsimg</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="">Thinking behind ts2img</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#possible-steps-involved-in-the-conversion">Possible steps involved in the conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#solution">Solution</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">Module Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/repurpose.html">repurpose package</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/tests.html">tests package</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">imgtsimg</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>ts2img</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/ts2img.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="ts2img">
<span id="id1"></span><h1>ts2img<a class="headerlink" href="#ts2img" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Conversion of time series data to images (ts2img) is a general problem
that we have to deal with often for all kinds of datasets. Although most
of the external datasets we use come in image format most of them are
converted into a time series format for analysis. This is fairly
straightforward for image stacks but gets more complicated for orbit
data.</p>
<p>Orbit data mostly comes as several data values accompanied by latitude,
longitude information and must often be resampled to fit on a grid that
lends itself for time series analysis. A more or less general solution
for this already exists in the img2ts module.</p>
</div>
<div class="section" id="possible-steps-involved-in-the-conversion">
<h2>Possible steps involved in the conversion<a class="headerlink" href="#possible-steps-involved-in-the-conversion" title="Permalink to this headline">¶</a></h2>
<p>The steps that a ts2img program might have to perform are:</p>
<ol class="arabic simple">
<li>Read time series in a geographic region - constrained by memory</li>
<li>Aggregate time series in time<ul>
<li>methods for doing this aggregation can vary for each dataset so
the method is best specified by the user</li>
<li>resolution in time has to be chosen and is probably also best
specified by the user</li>
<li>after aggregation every point in time and in space must have a
value which can of course be NaN</li>
<li>time series might have to be split into separate images during
conversion, e.g. ASCAT time series are routinely split into images
for ascending and descending satellite overpasses. <strong>This means
that we can not assume that the output dataset has the same number
or names of variables as the input dataset.</strong></li>
</ul>
</li>
<li>Put the now uniform time series of equal length into a 2D array per
variable</li>
<li>A resampling step could be performed here but since only a part of
the dataset is available edge cases would not be resolved correctly.
A better solution would be to develop a good resampling tool which
might already exist in pyresample and pytesmo functions that use it.</li>
<li>write this data into a file<ul>
<li>this can be a netCDF file with dimensions of the grid into which
the data is written</li>
<li>this could be any other file format, the interface to this format
just has to make sure that in the end a consistent image dataset
is built out of the parts that are written.</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">¶</a></h2>
<p>The chosen first solution uses netCDF as an output format. The output
will be a stack of images in netCDF format. This format can easily be
converted into substacks or single images if that is needed for a
certain user or project.</p>
<p>The chosen solution will <strong>not</strong> do resampling since this is better and
easier done using the whole converted dataset. This also means that if
the input dataset is e.g. a dataset defined over land only then the
resulting &#8220;image&#8221; will also not contain land points. I think it is best
to let this be decided by the input dataset.</p>
<p>The output of the resulting netCDF can have one of two possible
&#8220;shapes&#8221;:</p>
<ul class="simple">
<li>2D variables with time on one axis and gpi on the other. This is kind
of how SWI time series are stored already.</li>
<li>3D variables with latitude, longitude and time as the three
dimensions.</li>
</ul>
<p>The decision of which it will be is dependent on the grid on which the
input data is stored. If the grid has a 2D shape then the 3D solution
will be chosen. If the input grid has only a 1D shape then only the 2D
solution is possible.</p>
<div class="section" id="time-series-aggregation">
<h3>Time Series aggregation<a class="headerlink" href="#time-series-aggregation" title="Permalink to this headline">¶</a></h3>
<p>The chosen solution will use a custom function for each dataset to
perform the aggregation if necessary. A simple example of a function
that gets a time time series and aggregates it to a monthly time series
could look like <em>agg_tsmonthly</em></p>
<p>Simple example of a aggregation function</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">agg_tsmonthly</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ts : pandas.DataFrame</span>
<span class="sd">        time series of a point</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        any additional keyword arguments that are given to the ts2img object</span>
<span class="sd">        during initialization</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ts_agg : pandas.DataFrame</span>
<span class="sd">        aggregated time series, they all must have the same length</span>
<span class="sd">        otherwise it can not work</span>
<span class="sd">        each column of this DataFrame will be a layer in the image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># very simple example</span>
    <span class="c"># aggregate to monthly timestamp</span>
    <span class="c"># should also make sure that the output has a certain length</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s">&quot;M&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="time-series-iteration">
<h3>Time series iteration<a class="headerlink" href="#time-series-iteration" title="Permalink to this headline">¶</a></h3>
<p>The function <code class="docutils literal"><span class="pre">agg_tsmonthly</span></code> will be called for every time series in
the input dataset. The input dataset must have a <code class="docutils literal"><span class="pre">iter_ts</span></code>
iterator that iterates over the grid points in a sensible order.</p>
</div>
<div class="section" id="interface-to-the-netcdf-writer">
<h3>Interface to the netCDF writer<a class="headerlink" href="#interface-to-the-netcdf-writer" title="Permalink to this headline">¶</a></h3>
<p>The netCDF writer will be initialized outside the <em>ts2img</em> class with a
filename and other attributes it needs. So the <em>ts2img</em> class only gets
a writer object. This writer object already knows about the start and
end date of the time series as well as the target grid and has
initialized the correct dimensions in the netCDF file. This object must
have a method <code class="docutils literal"><span class="pre">write_ts</span></code> which takes a array of gpi&#8217;s and a 2D array
containing the time series for these gpis. This should be enough to
write the gpi&#8217;s into the correct position of the netCDF file.</p>
<p>This approach should also work if another output format is supposed to
be used.</p>
</div>
<div class="section" id="implementation-of-the-main-ts2img-class">
<h3>Implementation of the main ts2img class<a class="headerlink" href="#implementation-of-the-main-ts2img-class" title="Permalink to this headline">¶</a></h3>
<p>The ts2img class will automatically use a the function given in
<code class="docutils literal"><span class="pre">agg_ts2img</span></code> if no custom <code class="docutils literal"><span class="pre">agg_ts2img</span></code> function is provided. If
the tsreader implements a method called <code class="docutils literal"><span class="pre">agg_ts2img</span></code> this function
will be used instead.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Ts2Img</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a time series dataset and converts it</span>
<span class="sd">    into an image dataset.</span>
<span class="sd">    A custom aggregate function should be given otherwise</span>
<span class="sd">    a daily mean will be used</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tsreader: object</span>
<span class="sd">        object that implements a iter_ts method which iterates over</span>
<span class="sd">        pandas time series and has a grid attribute that is a pytesmo</span>
<span class="sd">        BasicGrid or CellGrid</span>
<span class="sd">    imgwriter: object</span>
<span class="sd">        writer object that implements a write_ts method that takes</span>
<span class="sd">        a list of grid point indices and a 2D array containing the time series data</span>
<span class="sd">    agg_func: function</span>
<span class="sd">        function that takes a pandas DataFrame and returns</span>
<span class="sd">        an aggregated pandas DataFrame</span>
<span class="sd">    ts_buffer: int</span>
<span class="sd">        how many time series to read before writing to disk,</span>
<span class="sd">        constrained by the working memory the process should use.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsreader</span><span class="p">,</span> <span class="n">imgwriter</span><span class="p">,</span>
                 <span class="n">agg_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">ts_buffer</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">agg_func</span> <span class="o">=</span> <span class="n">agg_func</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agg_func</span> <span class="o">=</span> <span class="n">tsreader</span><span class="o">.</span><span class="n">agg_ts2img</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agg_func</span> <span class="o">=</span> <span class="n">agg_tsmonthly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsreader</span> <span class="o">=</span> <span class="n">tsreader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgwriter</span> <span class="o">=</span> <span class="n">imgwriter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_buffer</span> <span class="o">=</span> <span class="n">ts_buffer</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">tsaggkw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        does the conversion from time series to images</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">gpis</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsbulk</span><span class="p">(</span><span class="o">**</span><span class="n">tsaggkw</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgwriter</span><span class="o">.</span><span class="n">write_ts</span><span class="p">(</span><span class="n">gpis</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tsbulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpis</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">tsaggkw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        iterator over gpi and time series arrays of size self.ts_buffer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gpis: iterable, optional</span>
<span class="sd">            if given these gpis will be used, can be practical</span>
<span class="sd">            if the gpis are managed by an external class e.g. for parallel</span>
<span class="sd">            processing</span>
<span class="sd">        tsaggkw: dict</span>
<span class="sd">            Keywords to give to the time series aggregation function</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gpi_array: numpy.array</span>
<span class="sd">            numpy array of gpis in this batch</span>
<span class="sd">        ts_bulk: dict of numpy arrays</span>
<span class="sd">            for each variable one numpy array of shape</span>
<span class="sd">            (len(gpi_array), len(ts_aggregated))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># have to use the grid iteration as long as iter_ts only returns</span>
        <span class="c"># data frame and no time series object including relevant metadata</span>
        <span class="c"># of the time series</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gpi_bulk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ts_bulk</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ts_index</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">gpis</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gpis</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsreader</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_points</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">gpi</span> <span class="ow">in</span> <span class="n">gpis</span><span class="p">:</span>
            <span class="n">gpi_bulk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpi</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsreader</span><span class="o">.</span><span class="n">read_ts</span><span class="p">(</span><span class="n">gpi</span><span class="p">)</span>
            <span class="n">ts_agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_func</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">tsaggkw</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">ts_agg</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ts_bulk</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_agg</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">ts_bulk</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">ts_bulk</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_agg</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ts_index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ts_index</span> <span class="o">=</span> <span class="n">ts_agg</span><span class="o">.</span><span class="n">index</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_buffer</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ts_bulk</span><span class="p">:</span>
                    <span class="n">ts_bulk</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ts_bulk</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">gpi_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">gpi_bulk</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">gpi_array</span><span class="p">,</span> <span class="n">ts_bulk</span>
                <span class="n">ts_bulk</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">gpi_bulk</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ts_bulk</span><span class="p">:</span>
                <span class="n">ts_bulk</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ts_bulk</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">gpi_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">gpi_bulk</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">gpi_array</span><span class="p">,</span> <span class="n">ts_bulk</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="license.html" class="btn btn-neutral float-right" title="License">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="repurpose"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Christoph Paulik.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.post0.dev15+g4937be2.dirty',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>eqcorrscan.core.match_filter &mdash; EQcorrscan 0.1.4rc documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/EQcorrscan_logo.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="EQcorrscan 0.1.4rc documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> EQcorrscan
          

          
            
            <img src="../../../_static/EQcorrscan_logo.jpg" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">1. Introduction to the EQcorrscan package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../updates.html">2. What&#8217;s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">3. EQcorrscan tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core.html">3. Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">4. Utils</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">EQcorrscan</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>eqcorrscan.core.match_filter</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for eqcorrscan.core.match_filter</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions for network matched-filter detection of seismic data.</span>
<span class="sd">Designed to cross-correlate templates generated by template_gen function</span>
<span class="sd">with data and output the detections.  The central component of this is</span>
<span class="sd">the match_template function from the openCV image processing package.  This</span>
<span class="sd">is a highly optimized and accurate normalized cross-correlation routine.</span>
<span class="sd">The details of this code can be found here: `OpenCV object detection</span>
<span class="sd">&lt;http://docs.opencv.org/2.4/modules/imgproc/doc/object_detection.html&gt;`_</span>

<span class="sd">:copyright:</span>
<span class="sd">    EQcorrscan developers.</span>

<span class="sd">:license:</span>
<span class="sd">    GNU Lesser General Public License, Version 3</span>
<span class="sd">    (https://www.gnu.org/copyleft/lesser.html)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">obspy</span> <span class="k">import</span> <span class="n">Trace</span><span class="p">,</span> <span class="n">Catalog</span><span class="p">,</span> <span class="n">UTCDateTime</span><span class="p">,</span> <span class="n">Stream</span>
<span class="kn">from</span> <span class="nn">obspy.core.event</span> <span class="k">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Pick</span><span class="p">,</span> <span class="n">CreationInfo</span><span class="p">,</span> <span class="n">ResourceIdentifier</span>
<span class="kn">from</span> <span class="nn">obspy.core.event</span> <span class="k">import</span> <span class="n">Comment</span><span class="p">,</span> <span class="n">WaveformStreamID</span>

<span class="kn">from</span> <span class="nn">eqcorrscan.utils.timer</span> <span class="k">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">eqcorrscan.utils</span> <span class="k">import</span> <span class="n">findpeaks</span>


<span class="k">class</span> <span class="nc">MatchFilterError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Default error for match-filter errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;MatchFilterError: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<div class="viewcode-block" id="DETECTION"><a class="viewcode-back" href="../../../submodules/core.match_filter.DETECTION.html#eqcorrscan.core.match_filter.DETECTION">[docs]</a><span class="k">class</span> <span class="nc">DETECTION</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Single detection from detection routines in eqcorrscan.</span>
<span class="sd">    Information required for a full detection based on cross-channel \</span>
<span class="sd">    correlation sums.</span>

<span class="sd">    :type template_name: str</span>
<span class="sd">    :param template_name: The name of the template for which this \</span>
<span class="sd">        detection was made.</span>
<span class="sd">    :type detect_time: obspy.core.utcdatetime.UTCDateTime</span>
<span class="sd">    :param detect_time: Time of detection as an obspy UTCDateTime object</span>
<span class="sd">    :type no_chans: int</span>
<span class="sd">    :param no_chans: The number of channels for which the cross-channel \</span>
<span class="sd">        correlation sum was calculated over.</span>
<span class="sd">    :type detect_val: float</span>
<span class="sd">    :param detect_val: The raw value of the cross-channel correlation sum \</span>
<span class="sd">        for this detection.</span>
<span class="sd">    :type threshold: float</span>
<span class="sd">    :param threshold: The value of the threshold used for this detection, \</span>
<span class="sd">        will be the raw threshold value related to the cccsum.</span>
<span class="sd">    :type typeofdet: str</span>
<span class="sd">    :param typeofdet: Type of detection, STA, corr, bright</span>
<span class="sd">    :type chans: list</span>
<span class="sd">    :param chans: List of stations for the detection</span>
<span class="sd">    :type event: obspy.core.event.event.Event</span>
<span class="sd">    :param event:</span>
<span class="sd">        Obspy Event object for this detection, note that this is lost when</span>
<span class="sd">        writing to a :class:`DETECTION` objects to csv files using</span>
<span class="sd">        :func:`eqcorrscan.core.match_filter.DETECTION.write`</span>
<span class="sd">    :type id: str</span>
<span class="sd">    :param id: Identification for detection (should be unique).</span>

<span class="sd">    .. todo:: Use Obspy.core.event class instead of detection. Requires \</span>
<span class="sd">        internal knowledge of template parameters - which needs changes to \</span>
<span class="sd">        how templates are stored.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DETECTION.__init__"><a class="viewcode-back" href="../../../submodules/core.match_filter.DETECTION.html#eqcorrscan.core.match_filter.DETECTION.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">detect_time</span><span class="p">,</span>
                 <span class="n">no_chans</span><span class="p">,</span> <span class="n">detect_val</span><span class="p">,</span>
                 <span class="n">threshold</span><span class="p">,</span> <span class="n">typeofdet</span><span class="p">,</span>
                 <span class="n">chans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Main class of DETECTION.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="o">=</span> <span class="n">template_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detect_time</span> <span class="o">=</span> <span class="n">detect_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_chans</span> <span class="o">=</span> <span class="n">no_chans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chans</span> <span class="o">=</span> <span class="n">chans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detect_val</span> <span class="o">=</span> <span class="n">detect_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typeofdet</span> <span class="o">=</span> <span class="n">typeofdet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                       <span class="n">detect_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple print.&quot;&quot;&quot;</span>
        <span class="n">print_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;template name=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;detection id=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;detection time=&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detect_time</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;number of channels=&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_chans</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;channels=&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chans</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;detection value=&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detect_val</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;threshold=&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;detection type=&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typeofdet</span><span class="p">)])</span>
        <span class="k">return</span> <span class="s2">&quot;DETECTION(&quot;</span> <span class="o">+</span> <span class="n">print_str</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Full print.&quot;&quot;&quot;</span>
        <span class="n">print_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Detection on template:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span>
                              <span class="s1">&#39;at:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detect_time</span><span class="p">),</span>
                              <span class="s1">&#39;with&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_chans</span><span class="p">),</span> <span class="s1">&#39;channels:&#39;</span><span class="p">,</span>
                              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chans</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">print_str</span>

<div class="viewcode-block" id="DETECTION.write"><a class="viewcode-back" href="../../../submodules/core.match_filter.DETECTION.html#eqcorrscan.core.match_filter.DETECTION.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write detection to file.</span>
<span class="sd">        Will append if append==True and file exists</span>

<span class="sd">        :type fname: str</span>
<span class="sd">        :param fname: Full path to file to open and write to.</span>
<span class="sd">        :type append: bool</span>
<span class="sd">        :param append: Set to true to append to an existing file, if True \</span>
<span class="sd">            and file doesn&#39;t exist, will create new file and warn.  If False</span>
<span class="sd">            will overwrite old files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">append</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Template name&#39;</span><span class="p">,</span> <span class="s1">&#39;Detection time (UTC)&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Number of channels&#39;</span><span class="p">,</span> <span class="s1">&#39;Channel list&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Detection value&#39;</span><span class="p">,</span> <span class="s1">&#39;Threshold&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Detection type&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># Write a header for the file</span>
        <span class="n">print_str</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detect_time</span><span class="p">),</span>
                               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_chans</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chans</span><span class="p">),</span>
                               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detect_val</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">typeofdet</span><span class="p">])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">print_str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="read_detections"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.core.match_filter.read_detections.html#eqcorrscan.core.match_filter.read_detections">[docs]</a><span class="k">def</span> <span class="nf">read_detections</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read detections from a file to a list of DETECTION objects.</span>

<span class="sd">    :type fname: str</span>
<span class="sd">    :param fname: File to read from, must be a file written to by \</span>
<span class="sd">        DETECTION.write.</span>

<span class="sd">    :returns: list of :class:`eqcorrscan.core.match_filter.DETECTION`</span>
<span class="sd">    :rtype: list</span>

<span class="sd">    .. note::</span>
<span class="sd">        :class:`eqcorrscan.core.match_filter.DETECTION`&#39;s returned do not</span>
<span class="sd">        contain DETECTION.event</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># Skip header</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Template name&#39;</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># Skip any repeated headers</span>
        <span class="n">detection</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;; &#39;</span><span class="p">)</span>
        <span class="n">detection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">detection</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">detection</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">detection</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">detection</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">detections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DETECTION</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="n">detection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">detect_time</span><span class="o">=</span><span class="n">detection</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">no_chans</span><span class="o">=</span><span class="n">detection</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                    <span class="n">detect_val</span><span class="o">=</span><span class="n">detection</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                    <span class="n">threshold</span><span class="o">=</span><span class="n">detection</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                    <span class="n">typeofdet</span><span class="o">=</span><span class="n">detection</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                    <span class="n">chans</span><span class="o">=</span><span class="n">detection</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">detections</span></div>


<span class="k">def</span> <span class="nf">write_catalog</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;QUAKEML&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write events contained within detections to a catalog file.</span>

<span class="sd">    :type detections: list</span>
<span class="sd">    :param detections: list of eqcorrscan.core.match_filter.DETECTION</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :param fname: Name of the file to write to</span>
<span class="sd">    :type format: str</span>
<span class="sd">    :param format: File format to use, see obspy.core.event.Catalog.write \</span>
<span class="sd">        for supported formats.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">get_catalog</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span>
    <span class="n">catalog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>


<div class="viewcode-block" id="get_catalog"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.core.match_filter.get_catalog.html#eqcorrscan.core.match_filter.get_catalog">[docs]</a><span class="k">def</span> <span class="nf">get_catalog</span><span class="p">(</span><span class="n">detections</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate an :class:`obspy.core.event.Catalog` from list of \</span>
<span class="sd">    :class:`DETECTION`&#39;s.</span>

<span class="sd">    :type detections: list</span>
<span class="sd">    :param detections: list of :class:`eqcorrscan.core.match_filter.DETECTION`</span>

<span class="sd">    :returns: Catalog of detected events.</span>
<span class="sd">    :rtype: :class:`obspy.core.event.Catalog`</span>

<span class="sd">    .. warning::</span>
<span class="sd">        Will only work if the detections have an event associated with them.</span>
<span class="sd">        This will not be the case if detections have been written to csv</span>
<span class="sd">        format using :func:`eqcorrscan.core.match_filter.DETECTION.write`</span>
<span class="sd">        and read back in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
        <span class="n">catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">catalog</span></div>


<div class="viewcode-block" id="extract_from_stream"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.core.match_filter.extract_from_stream.html#eqcorrscan.core.match_filter.extract_from_stream">[docs]</a><span class="k">def</span> <span class="nf">extract_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract waveforms for a list of detections from a stream.</span>

<span class="sd">    :type stream: obspy.core.stream.Stream</span>
<span class="sd">    :param stream: Stream containing the detections.</span>
<span class="sd">    :type detections: list</span>
<span class="sd">    :param detections: list of eqcorrscan.core.match_filter.detection</span>
<span class="sd">    :type pad: float</span>
<span class="sd">    :param pad: Pre-detection extract time in seconds.</span>
<span class="sd">    :type length: float</span>
<span class="sd">    :param length: Total extracted length in seconds.</span>

<span class="sd">    :returns:</span>
<span class="sd">        list of :class:`obspy.core.stream.Stream`, one for each detection.</span>
<span class="sd">    :type: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">streams</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
        <span class="n">cut_stream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">cut_stream</span><span class="p">:</span>
            <span class="n">pick</span> <span class="o">=</span> <span class="p">[</span><span class="n">pick</span> <span class="k">for</span> <span class="n">pick</span> <span class="ow">in</span> <span class="n">detection</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">picks</span> <span class="k">if</span>
                    <span class="n">pick</span><span class="o">.</span><span class="n">waveform_id</span><span class="o">.</span><span class="n">station_code</span> <span class="o">==</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="ow">and</span>
                    <span class="n">pick</span><span class="o">.</span><span class="n">waveform_id</span><span class="o">.</span><span class="n">channel_code</span> <span class="o">==</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">pick</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">pad</span><span class="p">,</span>
                    <span class="n">endtime</span><span class="o">=</span><span class="n">pick</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cut_stream</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">streams</span></div>


<div class="viewcode-block" id="normxcorr2"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.core.match_filter.normxcorr2.html#eqcorrscan.core.match_filter.normxcorr2">[docs]</a><span class="k">def</span> <span class="nf">normxcorr2</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thin wrapper on openCV match_template function.</span>

<span class="sd">    Base function to call the correlation routine from the</span>
<span class="sd">    openCV image processing suite.  Requires you to have installed the</span>
<span class="sd">    openCV python bindings.</span>

<span class="sd">    Here we use the :func:`cv2.TM_CCOEFF_NORMED` method within openCV to</span>
<span class="sd">    give the normalized cross-correlation.  Documentation on this function</span>
<span class="sd">    can be found here: `cv2.matchTemplate</span>
<span class="sd">    &lt;http://docs.opencv.org/modules/imgproc/doc/object_detection.html?highlight=matchtemplate#cv2.matchTemplate&gt;`_</span>

<span class="sd">    :type template: numpy.ndarray</span>
<span class="sd">    :param template: Template array</span>
<span class="sd">    :type image: numpy.ndarray</span>
<span class="sd">    :param image:</span>
<span class="sd">        Image to scan the template through.  The order of these</span>
<span class="sd">        matters, if you put the template after the image you will get a</span>
<span class="sd">        reversed correlation matrix</span>

<span class="sd">    :return:</span>
<span class="sd">        New :class:`numpy.ndarray` of the correlation values for the</span>
<span class="sd">        correlation of the image with the template.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check that we have been passed numpy arrays</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You have not provided numpy arrays, I will not convert them&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;NaN&#39;</span>
    <span class="c1"># Convert numpy arrays to float 32</span>
    <span class="n">cv_template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">cv_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ccc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">cv_image</span><span class="p">,</span> <span class="n">cv_template</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCOEFF_NORMED</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cv_image</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cv_template</span><span class="p">)):</span>
        <span class="n">ccc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccc</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ccc</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cv_template</span><span class="p">))</span> <span class="ow">or</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cv_image</span><span class="p">))):</span>
        <span class="n">ccc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccc</span><span class="p">))</span>
        <span class="c1"># Convert an array of perfect correlations to zero cross-correlations</span>
    <span class="c1"># Reshape ccc to be a 1D vector as is useful for seismic data</span>
    <span class="n">ccc</span> <span class="o">=</span> <span class="n">ccc</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccc</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">ccc</span></div>


<div class="viewcode-block" id="_template_loop"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.core.match_filter._template_loop.html#eqcorrscan.core.match_filter._template_loop">[docs]</a><span class="k">def</span> <span class="nf">_template_loop</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">stream_ind</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle individual template correlations.</span>

<span class="sd">    Sister loop to handle the correlation of a single template (of multiple</span>
<span class="sd">    channels) with a single channel of data.</span>

<span class="sd">    :type template: obspy.core.stream.Stream</span>
<span class="sd">    :param template: Template to correlate</span>
<span class="sd">    :type chan: numpy.ndarray</span>
<span class="sd">    :param chan: Single channel of continuous data to correlate</span>
<span class="sd">    :type stream_ind: int</span>
<span class="sd">    :param stream_ind: Index of channel to use in template</span>
<span class="sd">    :type debug: int</span>
<span class="sd">    :param debug: Debug level from 0-5, higher is more output.</span>
<span class="sd">    :type i: int</span>
<span class="sd">    :param i:</span>
<span class="sd">        Optional argument, used to keep track of which process is being run.</span>

<span class="sd">    :returns: tuple of (i, ccc) with ccc as an :class:`numpy.ndarray`</span>
<span class="sd">    :rtype: tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_data</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="n">stream_ind</span><span class="p">]</span>
    <span class="n">station</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span>
    <span class="c1"># template per-channel</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> \
        <span class="n">template</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s1">&#39;starttime&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span> <span class="o">*</span>
                                   <span class="n">template_data</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)))</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">pad</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">):]</span>
    <span class="n">ccc</span> <span class="o">=</span> <span class="p">(</span><span class="n">normxcorr2</span><span class="p">(</span><span class="n">template_data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">image</span><span class="p">))</span>
    <span class="n">ccc</span> <span class="o">=</span> <span class="n">ccc</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
    <span class="c1"># Convert to float16 to save memory for large problems - lose some</span>
    <span class="c1"># accuracy which will affect detections very close to threshold</span>
    <span class="c1">#</span>
    <span class="c1"># There is an interesting issue found in the tests that sometimes what</span>
    <span class="c1"># should be a perfect correlation results in a max of ccc of 0.99999994</span>
    <span class="c1"># Converting to float16 &#39;corrects&#39; this to 1.0 - bad workaround.</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;********* DEBUG:  &#39;</span> <span class="o">+</span> <span class="n">station</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
              <span class="n">channel</span> <span class="o">+</span> <span class="s1">&#39; ccc MAX: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ccc</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;********* DEBUG:  &#39;</span> <span class="o">+</span> <span class="n">station</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
              <span class="n">channel</span> <span class="o">+</span> <span class="s1">&#39; ccc MEAN: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ccc</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ccc</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Mean of ccc is infinite, check!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;inf_cccmean_ccc_</span><span class="si">%02d</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">ccc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;inf_cccmean_template_</span><span class="si">%02d</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">template_data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;inf_cccmean_image_</span><span class="si">%02d</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        <span class="n">ccc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccc</span><span class="p">))</span>
        <span class="n">ccc</span> <span class="o">=</span> <span class="n">ccc</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccc</span><span class="p">)))</span>
        <span class="c1"># Returns zeros</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shape of ccc: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ccc</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A single ccc is using: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ccc</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;MB&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ccc type is: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ccc</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shape of ccc: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ccc</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parallel worker &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; complete&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">ccc</span></div>


<div class="viewcode-block" id="_channel_loop"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.core.match_filter._channel_loop.html#eqcorrscan.core.match_filter._channel_loop">[docs]</a><span class="k">def</span> <span class="nf">_channel_loop</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal loop for parallel processing.</span>

<span class="sd">    Loop to generate cross channel correlation sums for a series of templates \</span>
<span class="sd">    hands off the actual correlations to a sister function which can be run \</span>
<span class="sd">    in parallel.</span>

<span class="sd">    :type templates: list</span>
<span class="sd">    :param templates: A list of templates, where each one should be an \</span>
<span class="sd">        obspy.Stream object containing multiple traces of seismic data and \</span>
<span class="sd">        the relevant header information. If do_subspace is True, templates \</span>
<span class="sd">        should be a list of lists of obspy.Stream objects, one list for each \</span>
<span class="sd">        detector of length n, where n is the number of singular vectors.</span>
<span class="sd">    :type stream: obspy.core.stream.Stream</span>
<span class="sd">    :param stream: A single Stream object to be correlated with the \</span>
<span class="sd">        templates.  This is in effect the image in normxcorr2 and cv2.</span>
<span class="sd">    :type cores: int</span>
<span class="sd">    :param cores: Number of cores to loop over</span>
<span class="sd">    :type debug: int</span>
<span class="sd">    :param debug: Debug level.</span>

<span class="sd">    :returns:</span>
<span class="sd">        New list of :class:`numpy.ndarray` objects.  These will contain</span>
<span class="sd">        the correlation sums for each template for this day of data.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    :returns:</span>
<span class="sd">        list of ints as number of channels used for each cross-correlation.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    :returns:</span>
<span class="sd">        list of list of tuples of station, channel for all cross-correlations.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_cores</span> <span class="o">=</span> <span class="n">cores</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_cores</span><span class="p">:</span>
        <span class="n">num_cores</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span>
    <span class="c1"># Initialize cccs_matrix, which will be two arrays of len(templates) arrays</span>
    <span class="c1"># where the arrays cccs_matrix[0[:]] will be the cross channel sum for each</span>
    <span class="c1"># template.</span>

    <span class="c1"># Note: This requires all templates to be the same length, and all channels</span>
    <span class="c1"># to be the same length</span>
    <span class="n">temp_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">cccs_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span>
                                     <span class="n">temp_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))]</span> <span class="o">*</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">))]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># Initialize number of channels array</span>
    <span class="n">no_chans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">))</span>
    <span class="n">chans</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">))]</span>

    <span class="c1"># Match-filter enforces that each template is the same length...</span>
    <span class="k">for</span> <span class="n">stream_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">stream_ind</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">stream_ind</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="s1">&#39;Multiple channels in continuous data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tr_data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting parallel run for station &quot;</span> <span class="o">+</span> <span class="n">station</span> <span class="o">+</span>
                  <span class="s2">&quot; channel &quot;</span> <span class="o">+</span> <span class="n">channel</span><span class="p">)</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="c1"># Send off to sister function</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_cores</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">_template_loop</span><span class="p">,</span>
                                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tr_data</span><span class="p">,</span>
                                              <span class="n">stream_ind</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">))]</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------- TIMER:    Correlation loop took: </span><span class="si">%s</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; I have &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; results&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">cccs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------- TIMER:    Getting results took: </span><span class="si">%s</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="c1"># Sort by placeholder returned from _template_loop</span>
            <span class="n">cccs_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------- TIMER:    Sorting took: </span><span class="si">%s</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">cccs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ccc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ccc</span> <span class="ow">in</span> <span class="n">cccs_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------- TIMER:    Extracting arrays took: </span><span class="si">%s</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cccs_list is shaped: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cccs_list</span><span class="p">)))</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">cccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">cccs_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------- TIMER:    cccs_list conversion: </span><span class="si">%s</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">cccs_list</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After looping through templates the cccs is shaped: &#39;</span> <span class="o">+</span>
                  <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cccs</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cccs is using: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cccs</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s1">&#39; MB of memory&#39;</span><span class="p">)</span>
        <span class="n">cccs_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cccs</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">),</span>
                                    <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cccs</span><span class="p">))))</span>
        <span class="k">del</span> <span class="n">cccs</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cccs_matrix shaped: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cccs_matrix</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cccs_matrix is using &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cccs_matrix</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s1">&#39; MB of memory&#39;</span><span class="p">)</span>
        <span class="c1"># Now we have an array of arrays with the first dimensional index</span>
        <span class="c1"># giving the channel, the second dimensional index giving the</span>
        <span class="c1"># template and the third dimensional index giving the position</span>
        <span class="c1"># in the ccc, e.g.:</span>
        <span class="c1"># np.shape(cccsums)=(len(stream), len(templates), len(ccc))</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cccs_matrix as a np.array is shaped: &#39;</span> <span class="o">+</span>
                  <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cccs_matrix</span><span class="p">)))</span>
        <span class="c1"># First work out how many channels were used</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cccs_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># Check that there are some real numbers in the vector rather</span>
                <span class="c1"># than being all 0, which is the default case for no match</span>
                <span class="c1"># of image and template names</span>
                <span class="n">no_chans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">chans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">))</span>
        <span class="c1"># Now sum along the channel axis for each template to give the</span>
        <span class="c1"># cccsum values for each template for each day</span>
        <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">cccsums</span> <span class="o">=</span> <span class="n">cccs_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------- TIMER:    Summing took </span><span class="si">%s</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cccsums is shaped thus: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cccsums</span><span class="p">)))</span>
        <span class="n">cccs_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cccsums</span>
        <span class="k">del</span> <span class="n">cccsums</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------- TIMER:    Trace loop took &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span> <span class="o">+</span>
                  <span class="s2">&quot; s&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cccs_matrix is shaped: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cccs_matrix</span><span class="p">)))</span>
    <span class="n">cccsums</span> <span class="o">=</span> <span class="n">cccs_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cccsums</span><span class="p">,</span> <span class="n">no_chans</span><span class="p">,</span> <span class="n">chans</span></div>


<div class="viewcode-block" id="match_filter"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.core.match_filter.match_filter.html#eqcorrscan.core.match_filter.match_filter">[docs]</a><span class="k">def</span> <span class="nf">match_filter</span><span class="p">(</span><span class="n">template_names</span><span class="p">,</span> <span class="n">template_list</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
                 <span class="n">threshold_type</span><span class="p">,</span> <span class="n">trig_int</span><span class="p">,</span> <span class="n">plotvar</span><span class="p">,</span> <span class="n">plotdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plot_format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span>
                 <span class="n">output_cat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extract_detections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">arg_check</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main matched-filter detection function.</span>

<span class="sd">    Over-arching code to run the correlations of given templates with a \</span>
<span class="sd">    day of seismic data and output the detections based on a given threshold.</span>
<span class="sd">    For a functional example see the tutorials.</span>

<span class="sd">    :type template_names: list</span>
<span class="sd">    :param template_names: List of template names in the same order as \</span>
<span class="sd">        template_list</span>
<span class="sd">    :type template_list: list</span>
<span class="sd">    :param template_list: A list of templates of which each template is a \</span>
<span class="sd">        Stream of obspy traces containing seismic data and header information.</span>
<span class="sd">    :type st: obspy.core.stream.Stream</span>
<span class="sd">    :param st: A Stream object containing all the data available and \</span>
<span class="sd">        required for the correlations with templates given.  For efficiency \</span>
<span class="sd">        this should contain no excess traces which are not in one or more of \</span>
<span class="sd">        the templates.  This will now remove excess traces internally, but \</span>
<span class="sd">        will copy the stream and work on the copy, leaving your input stream \</span>
<span class="sd">        untouched.</span>
<span class="sd">    :type threshold: float</span>
<span class="sd">    :param threshold: A threshold value set based on the threshold_type</span>
<span class="sd">    :type threshold_type: str</span>
<span class="sd">    :param threshold_type: The type of threshold to be used, can be MAD, \</span>
<span class="sd">        absolute or av_chan_corr.  See Note on thresholding below.</span>
<span class="sd">    :type trig_int: float</span>
<span class="sd">    :param trig_int: Minimum gap between detections in seconds.</span>
<span class="sd">    :type plotvar: bool</span>
<span class="sd">    :param plotvar: Turn plotting on or off</span>
<span class="sd">    :type plotdir: str</span>
<span class="sd">    :param plotdir: Path to plotting folder, plots will be output here, \</span>
<span class="sd">        defaults to run location.</span>
<span class="sd">    :type cores: int</span>
<span class="sd">    :param cores: Number of cores to use</span>
<span class="sd">    :type debug: int</span>
<span class="sd">    :param debug: Debug output level, the bigger the number, the more the \</span>
<span class="sd">        output.</span>
<span class="sd">    :type plot_format: str</span>
<span class="sd">    :param plot_format: Specify format of output plots if saved</span>
<span class="sd">    :type output_cat: bool</span>
<span class="sd">    :param output_cat: Specifies if matched_filter will output an \</span>
<span class="sd">        obspy.Catalog class containing events for each detection. Default \</span>
<span class="sd">        is False, in which case matched_filter will output a list of \</span>
<span class="sd">        detection classes, as normal.</span>
<span class="sd">    :type extract_detections: bool</span>
<span class="sd">    :param extract_detections: Specifies whether or not to return a list of \</span>
<span class="sd">        streams, one stream per detection.</span>
<span class="sd">    :type arg_check: bool</span>
<span class="sd">    :param arg_check: Check arguments, defaults to True, but if running in \</span>
<span class="sd">        bulk, and you are certain of your arguments, then set to False.\n</span>

<span class="sd">    .. rubric::</span>
<span class="sd">        If neither `output_cat` or `extract_detections` are set to `True`,</span>
<span class="sd">        then only the list of :class:`eqcorrscan.core.match_filter.DETECTION`&#39;s</span>
<span class="sd">        will be output:</span>
<span class="sd">    :return: :class:`eqcorrscan.core.match_filter.DETECTION`&#39;s detections for</span>
<span class="sd">        each detection made.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    .. rubric::</span>
<span class="sd">        If `output_cat` is set to `True`, then the</span>
<span class="sd">        :class:`obspy.core.event.Catalog` will also be output:</span>
<span class="sd">    :return: Catalog containing events for each detection, see above.</span>
<span class="sd">    :rtype: :class:`obspy.core.event.Catalog`</span>
<span class="sd">    .. rubric::</span>
<span class="sd">        If `extract_detections` is set to `True` then the list of</span>
<span class="sd">        :class:`obspy.core.stream.Stream`&#39;s will also be output.</span>
<span class="sd">    :return:</span>
<span class="sd">        list of :class:`obspy.core.stream.Stream`&#39;s for each detection, see</span>
<span class="sd">        above.</span>
<span class="sd">    :rtype: list</span>

<span class="sd">    .. warning::</span>
<span class="sd">        Plotting within the match-filter routine uses the Agg backend</span>
<span class="sd">        with interactive plotting turned off.  This is because the function</span>
<span class="sd">        is designed to work in bulk.  If you wish to turn interactive</span>
<span class="sd">        plotting on you must import matplotlib in your script first, when you</span>
<span class="sd">        them import match_filter you will get the warning that this call to</span>
<span class="sd">        matplotlib has no effect, which will mean that match_filter has not</span>
<span class="sd">        changed the plotting behaviour.</span>

<span class="sd">    .. note::</span>
<span class="sd">        **Thresholding:**</span>

<span class="sd">        **MAD** threshold is calculated as the:</span>

<span class="sd">        .. math::</span>

<span class="sd">            threshold {\\times} (median(abs(cccsum)))</span>

<span class="sd">        where :math:`cccsum` is the cross-correlation sum for a given template.</span>

<span class="sd">        **absolute** threshold is a true absolute threshold based on the</span>
<span class="sd">        cccsum value.</span>

<span class="sd">        **av_chan_corr** is based on the mean values of single-channel</span>
<span class="sd">        cross-correlations assuming all data are present as required for the</span>
<span class="sd">        template, e.g:</span>

<span class="sd">        .. math::</span>

<span class="sd">            av\_chan\_corr\_thresh=threshold \\times (cccsum / len(template))</span>

<span class="sd">        where :math:`template` is a single template from the input and the</span>
<span class="sd">        length is the number of channels within this template.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The output_cat flag will create an :class:`obspy.core.eventCatalog`</span>
<span class="sd">        containing one event for each</span>
<span class="sd">        :class:`eqcorrscan.core.match_filter.DETECTION`&#39;s generated by</span>
<span class="sd">        match_filter. Each event will contain a number of comments dealing</span>
<span class="sd">        with correlation values and channels used for the detection. Each</span>
<span class="sd">        channel used for the detection will have a corresponding</span>
<span class="sd">        :class:`obspy.core.event.Pick` which will contain time and</span>
<span class="sd">        waveform information. **HOWEVER**, the user should note that, at</span>
<span class="sd">        present, the pick times do not account for the</span>
<span class="sd">        prepick times inherent in each template. For example, if a template</span>
<span class="sd">        trace starts 0.1 seconds before the actual arrival of that phase,</span>
<span class="sd">        then the pick time generated by match_filter for that phase will be</span>
<span class="sd">        0.1 seconds early. We are looking towards a solution which will</span>
<span class="sd">        involve saving templates alongside associated metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
    <span class="kn">from</span> <span class="nn">eqcorrscan.utils</span> <span class="k">import</span> <span class="n">plotting</span>
    <span class="k">if</span> <span class="n">arg_check</span><span class="p">:</span>
        <span class="c1"># Check the arguments to be nice - if arguments wrong type the parallel</span>
        <span class="c1"># output for the error won&#39;t be useful</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">template_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="s1">&#39;template_names must be of type: list&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">template_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="s1">&#39;templates must be of type: list&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">template_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="o">==</span> <span class="n">Stream</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;template in template_list must be of type: &#39;</span> <span class="o">+</span>\
                      <span class="s1">&#39;obspy.core.stream.Stream&#39;</span>
                <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="n">Stream</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;st must be of type: obspy.core.stream.Stream&#39;</span>
            <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold_type</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;MAD&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;absolute&#39;</span><span class="p">),</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;av_chan_corr&#39;</span><span class="p">)]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;threshold_type must be one of: MAD, absolute, av_chan_corr&#39;</span>
            <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Copy the stream here because we will muck about with it</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">template_list</span><span class="p">)</span>
    <span class="c1"># Debug option to confirm that the channel names match those in the</span>
    <span class="c1"># templates</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">template_stachan</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data_stachan</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="s1">&#39;Template contains masked array,&#39;</span>
                                           <span class="s1">&#39; split first&#39;</span><span class="p">)</span>
                <span class="n">template_stachan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                                        <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">data_stachan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
        <span class="n">template_stachan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">template_stachan</span><span class="p">))</span>
        <span class="n">data_stachan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data_stachan</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I have template info for these stations:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">template_stachan</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I have daylong data for these stations:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">data_stachan</span><span class="p">)</span>
    <span class="c1"># Perform a check that the continuous data are all the same length</span>
    <span class="n">min_start_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">])</span>
    <span class="n">max_end_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">])</span>
    <span class="n">longest_trace_length</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_end_time</span> <span class="o">-</span>
                                                            <span class="n">min_start_time</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">==</span> <span class="n">longest_trace_length</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Data are not equal length, padding short traces&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">start_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">*</span>
                                     <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">min_start_time</span><span class="p">)))</span>
            <span class="n">end_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">*</span>
                                   <span class="p">(</span><span class="n">max_end_time</span> <span class="o">-</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)))</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">start_pad</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">end_pad</span><span class="p">])</span>
    <span class="c1"># Perform check that all template lengths are internally consistent</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">template_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Template </span><span class="si">%s</span><span class="s1"> contains traces of differing length!! THIS </span><span class="se">\</span>
<span class="s1">                  WILL CAUSE ISSUES&#39;</span> <span class="o">%</span> <span class="n">template_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="c1"># Call the _template_loop function to do all the correlation work</span>
    <span class="n">outtic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="c1"># Edit here from previous, stable, but slow match_filter</span>
    <span class="c1"># Would be worth testing without an if statement, but with every station in</span>
    <span class="c1"># the possible template stations having data, but for those without real</span>
    <span class="c1"># data make the data NaN to return NaN ccc_sum</span>
    <span class="c1"># Note: this works</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ensuring all template channels have matches in long data&#39;</span><span class="p">)</span>
    <span class="n">template_stachan</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
            <span class="n">template_stachan</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)]</span>
    <span class="n">template_stachan</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">template_stachan</span><span class="p">))</span>
    <span class="c1"># Copy this here to keep it safe</span>
    <span class="k">for</span> <span class="n">stachan</span> <span class="ow">in</span> <span class="n">template_stachan</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">stachan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channel</span><span class="o">=</span><span class="n">stachan</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># Remove template traces rather than adding NaN data</span>
            <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">stachan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channel</span><span class="o">=</span><span class="n">stachan</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">stachan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">channel</span><span class="o">=</span><span class="n">stachan</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">template</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="c1"># Remove un-needed channels</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="ow">in</span> <span class="n">template_stachan</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="c1"># Check for duplicate channels</span>
    <span class="n">stachans</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">]</span>
    <span class="n">c_stachans</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">stachans</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">c_stachans</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">c_stachans</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Multiple channels for </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">, likely a data issue&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="c1"># Also pad out templates to have all channels</span>
    <span class="k">for</span> <span class="n">template</span><span class="p">,</span> <span class="n">template_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">template_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;No channels matching in continuous data for &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;template&#39;</span> <span class="o">+</span> <span class="n">template_name</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">templates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="n">template_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">stachan</span> <span class="ow">in</span> <span class="n">template_stachan</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">template</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">stachan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channel</span><span class="o">=</span><span class="n">stachan</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">nulltrace</span> <span class="o">=</span> <span class="n">Trace</span><span class="p">()</span>
                <span class="n">nulltrace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">stachan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nulltrace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">stachan</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nulltrace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span>
                <span class="n">nulltrace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
                <span class="n">nulltrace</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                                          <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">+=</span> <span class="n">nulltrace</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting the correlation run for this day&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">cccsums</span><span class="p">,</span> <span class="n">no_chans</span><span class="p">,</span> <span class="n">chans</span><span class="p">]</span> <span class="o">=</span> <span class="n">_channel_loop</span><span class="p">(</span><span class="n">templates</span><span class="o">=</span><span class="n">templates</span><span class="p">,</span>
                                               <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
                                               <span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span>
                                               <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cccsums</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MatchFilterError</span><span class="p">(</span><span class="s1">&#39;Correlation has not run, zero length cccsum&#39;</span><span class="p">)</span>
    <span class="n">outtoc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Looping over templates and streams took:&#39;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">outtoc</span> <span class="o">-</span> <span class="n">outtic</span><span class="p">),</span> <span class="s1">&#39;s&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;The shape of the returned cccsums is:&#39;</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cccsums</span><span class="p">))]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;This is from&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">)),</span> <span class="s1">&#39;templates&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Correlated with&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stream</span><span class="p">)),</span>
                        <span class="s1">&#39;channels of data&#39;</span><span class="p">]))</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">output_cat</span><span class="p">:</span>
        <span class="n">det_cat</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cccsum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cccsums</span><span class="p">):</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">templates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;MAD&#39;</span><span class="p">):</span>
            <span class="n">rawthresh</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cccsum</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;absolute&#39;</span><span class="p">):</span>
            <span class="n">rawthresh</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;av_chan_corr&#39;</span><span class="p">):</span>
            <span class="n">rawthresh</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">no_chans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Findpeaks returns a list of tuples in the form [(cccsum, sample)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Threshold is set at:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rawthresh</span><span class="p">)]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Max of data is:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">cccsum</span><span class="p">))]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Mean of data is:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cccsum</span><span class="p">))]))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cccsum</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Mean is not zero!  Check this!&#39;</span><span class="p">)</span>
        <span class="c1"># Set up a trace object for the cccsum as this is easier to plot and</span>
        <span class="c1"># maintains timing</span>
        <span class="k">if</span> <span class="n">plotvar</span><span class="p">:</span>
            <span class="n">stream_plot</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># Downsample for plotting</span>
            <span class="n">stream_plot</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">cccsum_plot</span> <span class="o">=</span> <span class="n">Trace</span><span class="p">(</span><span class="n">cccsum</span><span class="p">)</span>
            <span class="n">cccsum_plot</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span>
            <span class="c1"># Resample here to maintain shape better</span>
            <span class="n">cccsum_hist</span> <span class="o">=</span> <span class="n">cccsum_plot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cccsum_hist</span> <span class="o">=</span> <span class="n">cccsum_hist</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span>
                                                   <span class="n">sampling_rate</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">data</span>
            <span class="n">cccsum_plot</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">chunk_data</span><span class="p">(</span><span class="n">cccsum_plot</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
                                              <span class="s1">&#39;Maxabs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="c1"># Enforce same length</span>
            <span class="n">stream_plot</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">stream_plot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">cccsum_plot</span><span class="p">)]</span>
            <span class="n">cccsum_plot</span> <span class="o">=</span> <span class="n">cccsum_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">stream_plot</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>
            <span class="n">cccsum_hist</span> <span class="o">=</span> <span class="n">cccsum_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">stream_plot</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>
            <span class="n">plotting</span><span class="o">.</span><span class="n">triple_plot</span><span class="p">(</span><span class="n">cccsum_plot</span><span class="p">,</span> <span class="n">cccsum_hist</span><span class="p">,</span>
                                 <span class="n">stream_plot</span><span class="p">,</span> <span class="n">rawthresh</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="n">plotdir</span> <span class="o">+</span> <span class="s1">&#39;/cccsum_plot_&#39;</span> <span class="o">+</span>
                                 <span class="n">template_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                 <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span>
                                 <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span>
                                 <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">plot_format</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Saved the cccsum to:&#39;</span><span class="p">,</span> <span class="n">template_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span>
                                <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%j&#39;</span><span class="p">)]))</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">template_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%j&#39;</span><span class="p">),</span>
                        <span class="n">cccsum</span><span class="p">)</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;cccsum_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">,</span> <span class="n">cccsum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">cccsum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rawthresh</span><span class="p">:</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">findpeaks</span><span class="o">.</span><span class="n">find_peaks2_short</span><span class="p">(</span><span class="n">cccsum</span><span class="p">,</span> <span class="n">rawthresh</span><span class="p">,</span>
                                                <span class="n">trig_int</span> <span class="o">*</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span>
                                                <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span>
                                                <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                                                <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">max</span><span class="p">(</span><span class="n">cccsum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rawthresh</span><span class="p">:</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">findpeaks</span><span class="o">.</span><span class="n">find_peaks2_short</span><span class="p">(</span><span class="n">cccsum</span><span class="p">,</span> <span class="n">rawthresh</span><span class="p">,</span>
                                                <span class="n">trig_int</span> <span class="o">*</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span>
                                                <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No peaks found above threshold&#39;</span><span class="p">)</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Finding peaks took:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">),</span> <span class="s1">&#39;s&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="n">detecttime</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span>\
                    <span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span>
                <span class="c1"># Detect time must be valid QuakeML uri within resource_id.</span>
                <span class="c1"># This will write a formatted string which is still</span>
                <span class="c1"># readable by UTCDateTime</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">ResourceIdentifier</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">template_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="n">detecttime</span><span class="o">.</span>
                                             <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)),</span>
                                         <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;smi:local&#39;</span><span class="p">)</span>
                <span class="n">ev</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">resource_id</span><span class="o">=</span><span class="n">rid</span><span class="p">)</span>
                <span class="n">cr_i</span> <span class="o">=</span> <span class="n">CreationInfo</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s1">&#39;EQcorrscan&#39;</span><span class="p">,</span>
                                    <span class="n">creation_time</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">())</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">creation_info</span> <span class="o">=</span> <span class="n">cr_i</span>
                <span class="c1"># All detection info in Comments for lack of a better idea</span>
                <span class="n">thresh_str</span> <span class="o">=</span> <span class="s1">&#39;threshold=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rawthresh</span><span class="p">)</span>
                <span class="n">ccc_str</span> <span class="o">=</span> <span class="s1">&#39;detect_val=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">used_chans</span> <span class="o">=</span> <span class="s1">&#39;channels used: &#39;</span> <span class="o">+</span>\
                             <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">chans</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Comment</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">thresh_str</span><span class="p">))</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Comment</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">ccc_str</span><span class="p">))</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Comment</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">used_chans</span><span class="p">))</span>
                <span class="n">min_template_tm</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chans</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pick_tm</span> <span class="o">=</span> <span class="n">detecttime</span> <span class="o">+</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span>
                                                <span class="n">min_template_tm</span><span class="p">)</span>
                        <span class="n">wv_id</span> <span class="o">=</span> <span class="n">WaveformStreamID</span><span class="p">(</span><span class="n">network_code</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                                                 <span class="n">station_code</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                                                 <span class="n">channel_code</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
                        <span class="n">ev</span><span class="o">.</span><span class="n">picks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pick</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">pick_tm</span><span class="p">,</span> <span class="n">waveform_id</span><span class="o">=</span><span class="n">wv_id</span><span class="p">))</span>
                <span class="n">detections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DETECTION</span><span class="p">(</span><span class="n">template_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                            <span class="n">detecttime</span><span class="p">,</span>
                                            <span class="n">no_chans</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rawthresh</span><span class="p">,</span>
                                            <span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="n">chans</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">event</span><span class="o">=</span><span class="n">ev</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">output_cat</span><span class="p">:</span>
                    <span class="n">det_cat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extract_detections</span><span class="p">:</span>
            <span class="n">detection_streams</span> <span class="o">=</span> <span class="n">extract_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">detections</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">stream</span><span class="p">,</span> <span class="n">templates</span>
    <span class="k">if</span> <span class="n">output_cat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">extract_detections</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">det_cat</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">extract_detections</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">detections</span>
    <span class="k">elif</span> <span class="n">extract_detections</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">output_cat</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">detection_streams</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">det_cat</span><span class="p">,</span> <span class="n">detection_streams</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, 2016: EQcorrscan developers.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.4rc',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>